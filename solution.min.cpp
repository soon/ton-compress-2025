
#include<iostream>
#include<sstream>
#include<fstream>
#include<set>
#include<stdio.h>
#include<string>
#include<vector>
#include<assert.h>
#include<stdint.h>
#include<stdlib.h>
#include<string.h>
#include<algorithm>
#include"common/util.h"
#include"vm/cells/CellSlice.h"
#include"td/utils/lz4.h"
#include"td/utils/misc.h"
#include"td/utils/buffer.h"
#define private public
#define final
#include"block/block-auto.h"
#include"block/block-parse.h"
#include"vm/boc.h"
#include"crypto/vm/boc-writers.h"
#define dC HashmapAugNode
#define dz skip
#define du in_msg_descr
#define ds as_cellslice
#define dr McBlockExtra
#define dq store_ptr
#define dp push_back
#define dm continue
#define di ShardFeeCreated
#define de true
#define dd ref_idx
#define db blen
#define cX out_msg_descr
#define cU class
#define cP else
#define cO template
#define cN bool
#define cG CurrencyCollection
#define cB fetch_ulong
#define cn state_update
#define cl special_type
#define bV HashmapAugE
#define bQ store_long
#define bO virtual
#define bN extra
#define bL append_cellslice
#define bK BufferSlice
#define bD string
#define bx write
#define bq size_t
#define bl fetch_ref
#define bj data
#define bi auto
#define bf char
#define be size
#define bb store_ref
#define ba while
#define V struct
#define U CellSlice
#define S CellBuilder
#define N void
#define J const
#define G unsigned
#define B return
#define u case
#define g break
using namespace vm;using namespace std;set<bD> enabled_optimizations{"Block","BlockExtra","bV","HashmapAug","dC","InMsgDescr","OutMsgDescr","dr","ShardFees","ShardAccountBlocks","MERKLE_UPDATE","Maybe",};U to_cs(Ref<Cell> cell){cN can_be_special=false;B load_cell_slice_special(std::move(cell),can_be_special);}V A{ostream&out;};cO<cU T_TLB>V K{U incoming_cs;U bJ;U ccs;bD name;T_TLB bo;int cl=0;K(bD name):K(name,T_TLB()){}K(bD name,T_TLB bo):name(name),bo(bo){}bO ~K(){}bO N bg(A&ctx,U&cs,int o=0){}bO N bt(A&ctx,S&cb,int o=0){bu(ctx,cb,o);}bO N bh(A&ctx,U&cs,int o=0){bg(ctx,cs,o);}bO N bu(A&ctx,S&cb,int o=0){}cN is_enabled(){B enabled_optimizations.count(name)> 0;}cN cV(){B cl==1;}N bw(A&ctx,U&cs,int o=0,cN cW=false){bi e=is_enabled();cl=(int)cs.cl();incoming_cs=cs;if(cV()){cs.advance(288);B;}if(e){bg(ctx,cs,o);}cP{bJ=bo.fetch(cs).bx();}}N bZ(A&ctx,S&cb,int o=0){bi e=is_enabled();if(cV()){cb.bL(incoming_cs);}cP if(e){bt(ctx,cb,o);}cP{cb.bL(bJ);}}N bC(A&ctx,U&cs,int o=0,cN cW=false){bi e=is_enabled();incoming_cs=cs;if(e){bh(ctx,cs,o);}cP{bJ=bo.fetch(cs).bx();}}N bM(A&ctx,S&cb,int o=0){bi e=is_enabled();if(cV()){cb.bL(incoming_cs);}cP if(e){bu(ctx,cb,o);}cP{if(!bJ.is_valid()){throw runtime_error(name+":optimization is disabled,but bJ is empty,meaning it was never set");}cb.bL(bJ);}}Ref<Cell> bc(A&ctx,int o=0){S cb;bM(ctx,cb,o);B cb.finalize(cl!=0);}Ref<Cell> by(A&ctx,int o=0){S cb;bZ(ctx,cb,o);B cb.finalize(cl!=0);}N bd(A&ctx,Ref<Cell> cell_ref,int o=0,cN cW=false){bi cs=to_cs(std::move(cell_ref));bw(ctx,cs,o,cW);}N bk(A&ctx,Ref<Cell> cell_ref,int o=0,cN cW=false){bi cs=to_cs(std::move(cell_ref));bC(ctx,cs,o,cW);}N fetch_remaining(U&cs){ccs=cs;cs.advance(cs.be());cs.advance_refs(cs.size_refs());}N append_remaining(S&cb){cb.bL(ccs);}};V ca{bO ~ca(){}bO U cw(){throw runtime_error("aug bj requested but not implemented");}};cO<cU T_TLB>V cx{T_TLB add_type;cx(T_TLB add_type):add_type(add_type){}cx():cx(T_TLB{}){}bO ~cx(){}bO U add_values(U&cs1,U&cs2){S cb;(add_type.add_values(cb,cs1,cs2));B cb.ds();}};using namespace block::tlb;J cG tCC;J OutMsg tOM;J AccountBlock tAB;J ImportFees tIF;J InMsg tIM;J EnqueuedMsg tEM;J UInt tU64{64};J di tSFC;cO<cU cJ,cU cA>V bA;cO<cU cJ,cU cA>V FullHashmapAugNode:K<block::gen::dC>{int tag=-1;int n=-1;Ref<bA<cJ,cA>> left;Ref<bA<cJ,cA>> right;cJ cc;cA bN;FullHashmapAugNode(int m,J TLB&X,J TLB&Y):K("dC",block::gen::dC(m,X,Y)){}N bg(A&ctx,U&cs,int o=0){tag=bo.check_tag(cs);if(tag==0){bN.bw(ctx,cs,o+1);cc.bw(ctx,cs,o+1);}cP{int n;add_r1(n,1,bo.m_);left=Ref<bA<cJ,cA>>(de,n,bo.X_,bo.Y_);left.bx().bd(ctx,cs.bl(),o+1);right=Ref<bA<cJ,cA>>(de,n,bo.X_,bo.Y_);right.bx().bd(ctx,cs.bl(),o+1);bN.bw(ctx,cs,o+1);}}N bt(A&ctx,S&cb,int o=0){if(tag==0){cc.bZ(ctx,cb,o+1);}cP{int n;(add_r1(n,1,bo.m_));cb.bb(left.bx().by(ctx,o+1));cb.bb(right.bx().by(ctx,o+1));}}N bh(A&ctx,U&cs,int o=0){tag=bo.check_tag(cs);if(tag==0){cc.bC(ctx,cs,o+1);bi extra_cs=cc.cw();bN.bC(ctx,extra_cs,o+1,de);}cP{int n;add_r1(n,1,bo.m_);left=Ref<bA<cJ,cA>>(de,n,bo.X_,bo.Y_);left.bx().bk(ctx,cs.bl(),o+1);right=Ref<bA<cJ,cA>>(de,n,bo.X_,bo.Y_);right.bx().bk(ctx,cs.bl(),o+1);bi left_extra_cs=to_cs(left.bx().node.bN.bc(ctx));bi right_extra_cs=to_cs(right.bx().node.bN.bc(ctx));bi extra_cs=bN.add_values(left_extra_cs,right_extra_cs);bN.bC(ctx,extra_cs,o+1,de);}}N bu(A&ctx,S&cb,int o=0){if(tag==0){bN.bM(ctx,cb,o+1);cc.bM(ctx,cb,o+1);}cP{int n;(add_r1(n,1,bo.m_));cb.bb(left.bx().bc(ctx,o+1));cb.bb(right.bx().bc(ctx,o+1));bN.bM(ctx,cb,o+1);}}};cO<cU cJ,cU cA>V bA:K<block::gen::HashmapAug>,td::CntObject{Ref<U> label;int n,m,l;FullHashmapAugNode<cJ,cA> node;bA(int n,J TLB&X,J TLB&Y):K("HashmapAug",block::gen::HashmapAug(n,X,Y)),node(n,X,Y){}N bg(A&ctx,U&cs,int o=0){n=bo.m_;(block::gen::HmLabel{n}.fetch_to(cs,label,l));m=n-l;node.bo.m_=m;node.bw(ctx,cs,o+1);}N bt(A&ctx,S&cb,int o=0){int l,m;(tlb::store_from(cb,HmLabel{bo.m_},label,l));(add_r1(m,l,bo.m_));node.bZ(ctx,cb,o+1);}N bh(A&ctx,U&cs,int o=0){(
(n=bo.m_)>= 0
&&block::gen::HmLabel{bo.m_}.fetch_to(cs,label,l)&&add_r1(m,l,bo.m_));node.bo.m_=m;node.bC(ctx,cs,o+1);}N bu(A&ctx,S&cb,int o=0){int l,m;(tlb::store_from(cb,block::gen::HmLabel{bo.m_},label,l)&&add_r1(m,l,bo.m_));node.bM(ctx,cb,o+1);}};cO<cU cJ,cU cA>V ce:K<block::gen::bV>{block::gen::bV::Record_ahme_root r;int tag=-1;bA<cJ,cA> root;cA bN;ce(int n,J TLB&X,J TLB&Y):K("bV",block::gen::bV(n,X,Y)),root(n,X,Y){}N bg(A&ctx,U&cs,int o=0){tag=bo.check_tag(cs);if(tag==block::gen::bV::ahme_empty){(cs.cB(1)== 0);bN.bw(ctx,cs,o+1);}cP{(bo.unpack(cs,r));root.bd(ctx,r.root,o+1);bN.bw(ctx,r.bN.bx(),o+1);}}N bt(A&ctx,S&cb,int o=0){if(tag==bV::ahme_empty){cb.bQ(0,1);bN.bZ(ctx,cb,o+1);}cP{cb.bQ(1,1).bb(root.by(ctx,o+1));}}N bh(A&ctx,U&cs,int o=0){tag=bo.check_tag(cs);if(tag==bV::ahme_empty){(cs.cB(1)== 0);bN.bC(ctx,cs,o+1);}cP{(cs.cB(1)== 1&&(r.n=bo.m_)>= 0);bi root_ref=cs.bl();root.bk(ctx,root_ref,o+1);bN=root.node.bN;}}N bu(A&ctx,S&cb,int o=0){if(tag==bV::ahme_empty){cb.bQ(0,1);bN.bM(ctx,cb,o+1);}cP{cb.bQ(1,1).bb(root.bc(ctx,o+1));bN.bM(ctx,cb,o+1);}}};cO<cU T>V FullMaybe:K<TLB>{T cc;int tag=-1;cN is_ref;FullMaybe(cN is_ref=false):K("Maybe"),is_ref(is_ref){}N bg(A&ctx,U&cs,int o=0){tag=cs.cB(1);if(tag){if(is_ref){cc.bd(ctx,cs.bl(),o+1);}cP{cc.bw(ctx,cs,o+1);}}}bO N bt(A&ctx,S&cb,int o=0){(cb.store_long_bool(tag,1));if(tag){if(is_ref){cb.bb(cc.by(ctx,o+1));}cP{cc.bZ(ctx,cb,o+1);}}}bO N bh(A&ctx,U&cs,int o=0){tag=cs.cB(1);if(tag){if(is_ref){cc.bk(ctx,cs.bl(),o+1);}cP{cc.bC(ctx,cs,o+1);}}}N bu(A&ctx,S&cb,int o=0){(cb.store_long_bool(tag,1));if(tag){if(is_ref){cb.bb(cc.bc(ctx,o+1));}cP{cc.bM(ctx,cb,o+1);}}}};V cK;V FullInMsg:K<InMsg>,ca{FullInMsg():K("InMsg",InMsg()){}U cw(){S cb;bi cs_copy=bJ;(bo.get_import_fees(cb,cs_copy));B cb.ds();}};V cf:K<cG>,cx<cG>{cf():K("cG"){}};V FullOutMsg:K<OutMsg>,ca{FullOutMsg():K("OutMsg",OutMsg()){}U cw(){S cb;bi cs_copy=bJ;(bo.get_export_value(cb,cs_copy));B cb.ds();}};cO<cU T>V FullMERKLE_UPDATE:K<TLB>{Ref<T> cQ,to_proof;FullMERKLE_UPDATE(J T&bo):K("MERKLE_UPDATE"){}N bg(A&ctx,U&cs,int o=0){(cs.advance(520));cQ=Ref<T>(de);cQ.bx().bd(ctx,cs.bl(),o+1);to_proof=Ref<T>(de);to_proof.bx().bd(ctx,cs.bl(),o+1);}N bt(A&ctx,S&cb,int o=0){cb.bb(cQ.bx().bc(ctx,o+1));cb.bb(to_proof.bx().bc(ctx,o+1));cl=0;}N bh(A&ctx,U&cs,int o=0){cQ=Ref<T>(de);cQ.bx().bd(ctx,cs.bl(),o+1);to_proof=Ref<T>(de);to_proof.bx().bd(ctx,cs.bl(),o+1);}Ref<Cell> bc(A&ctx,int o=0){B S::create_merkle_update(
cQ.bx().bc(ctx,o+1),to_proof.bx().bc(ctx,o+1));}};V FullAccountBlock:K<AccountBlock>,ca{FullAccountBlock():K("AccountBlock"){}U cw(){S cb;bi cs_copy=bJ;(Aug_ShardAccountBlocks().eval_leaf(cb,cs_copy));B cb.ds();}};V cR:K<block::gen::ShardAccountBlocks>{ce<FullAccountBlock,cf> x{256,tAB,tCC};cR():K("ShardAccountBlocks"){}N bg(A&ctx,U&cs,int o=0){x.bw(ctx,cs,o+1);}N bt(A&ctx,S&cb,int o=0){x.bZ(ctx,cb,o+1);}N bh(A&ctx,U&cs,int o=0){x.bC(ctx,cs,o+1);}N bu(A&ctx,S&cb,int o=0){x.bM(ctx,cb,o+1);}};V MyMcStateExtra:block::gen::McStateExtra{cN dz(vm::U&cs)J {B cs.advance(16)&&block::gen::ShardHashes().dz(cs)&&cs.advance_ext(0x100,2)&&tCC.dz(cs);}};V FullMcStateExtra:K<MyMcStateExtra>{FullMcStateExtra():K("McStateExtra",MyMcStateExtra()){}};J block::gen::ShardStateUnsplit_aux tSSUa;J block::gen::RefT tRMSE{MyMcStateExtra()};J block::gen::Maybe tMRMSE{tRMSE};V MyShardStateUnsplit:block::gen::ShardStateUnsplit{cN dz(vm::U&cs)J{B cs.advance_ext(0x169,3)&&tMRMSE.dz(cs);}};V FullShardState:K<ShardState>,td::CntObject{FullShardState():K("ShardState"){}};V cy:K<di>,ca,cx<di>{cy():K("di"){}U cw(){S cb;bi cs_copy=bJ;(Aug_ShardFees().eval_leaf(cb,cs_copy));B cb.ds();}};V FullShardFees:K<block::gen::ShardFees>{ce<cy,cy> x{96,tSFC,tSFC};FullShardFees():K("ShardFees"){}N bg(A&ctx,U&cs,int o=0){x.bw(ctx,cs,o+1);}N bt(A&ctx,S&cb,int o=0){x.bZ(ctx,cb,o+1);}N bh(A&ctx,U&cs,int o=0){x.bC(ctx,cs,o+1);}N bu(A&ctx,S&cb,int o=0){x.bM(ctx,cb,o+1);}};J block::gen::ShardHashes tSH;V FullMcBlockExtra:K<block::gen::dr>{block::gen::dr::Record bF;FullShardFees shard_fees;FullMcBlockExtra():K("dr"){}N bg(A&ctx,U&cs,int o=0){(cs.cB(16)== 0xcca5);(cs.fetch_bool_to(bF.key_block));(tSH.fetch_to(cs,bF.shard_hashes));shard_fees.bw(ctx,cs,o+1);fetch_remaining(cs);}N bt(A&ctx,S&cb,int o=0){cb.bQ(bF.key_block,1);tSH.store_from(cb,bF.shard_hashes);shard_fees.bZ(ctx,cb,o+1);append_remaining(cb);}N bh(A&ctx,U&cs,int o=0){(cs.fetch_bool_to(bF.key_block));(tSH.fetch_to(cs,bF.shard_hashes));shard_fees.bC(ctx,cs,o+1);fetch_remaining(cs);}N bu(A&ctx,S&cb,int o=0){cb.bQ(0xcca5,16).bQ(bF.key_block,1);tSH.store_from(cb,bF.shard_hashes);shard_fees.bM(ctx,cb,o+1);append_remaining(cb);}};V cK;V FullOutMsgDescr:K<OutMsgDescr>{ce<FullOutMsg,cf> x{256,tOM,tCC};FullOutMsgDescr():K("OutMsgDescr"){}N bg(A&ctx,U&cs,int o=0){x.bw(ctx,cs,o+1);}N bt(A&ctx,S&cb,int o=0){x.bZ(ctx,cb,o+1);}N bh(A&ctx,U&cs,int o=0){x.bC(ctx,cs,o+1);}N bu(A&ctx,S&cb,int o=0){x.bM(ctx,cb,o+1);}};V cK:K<ImportFees>,cx<ImportFees>{cK():K("ImportFees",tIF),cx(tIF){}};V FullInMsgDescr:K<InMsgDescr>{ce<FullInMsg,cK> x{256,tIM,tIF};FullInMsgDescr():K("InMsgDescr",InMsgDescr()){}N bg(A&ctx,U&cs,int o=0){x.bw(ctx,cs,o+1);}N bt(A&ctx,S&cb,int o=0){x.bZ(ctx,cb,o+1);}N bh(A&ctx,U&cs,int o=0){x.bC(ctx,cs,o+1);}N bu(A&ctx,S&cb,int o=0){x.bM(ctx,cb,o+1);}};J block::gen::dr tMBE{};J block::gen::RefT tRMBE{tMBE};J block::gen::Maybe tMRMBE(tRMBE);V FullBlockExtra:K<block::gen::BlockExtra>{block::gen::BlockExtra::Record bF;FullInMsgDescr du;FullOutMsgDescr cX;cR cL;FullMaybe<FullMcBlockExtra> custom;FullBlockExtra():K("BlockExtra"),custom(de){}N bg(A&ctx,U&cs,int o=0){((cs.cB(32)== 0x4a33f6fd));du.bd(ctx,cs.bl(),o+1);cX.bd(ctx,cs.bl(),o+1);cL.bd(ctx,cs.bl(),o+1);ccs=cs.fetch_subslice(512).bx();custom.bw(ctx,cs,o+1);}N bt(A&ctx,S&cb,int o=0){cb.bb(du.by(ctx,o+1)).bb(cX.by(ctx,o+1)).bb(cL.by(ctx,o+1)).bL(ccs);custom.bZ(ctx,cb,o+1);}N bh(A&ctx,U&cs,int o=0){du.bk(ctx,cs.bl(),o+1);cX.bk(ctx,cs.bl(),o+1);cL.bk(ctx,cs.bl(),o+1);ccs=cs.fetch_subslice(512).bx();custom.bC(ctx,cs,o+1);}N bu(A&ctx,S&cb,int o=0){cb.bQ(0x4a33f6fd,32).bb(du.bc(ctx,o+1)).bb(cX.bc(ctx,o+1)).bb(cL.bc(ctx,o+1)).bL(ccs);custom.bM(ctx,cb,o+1);}};V FullBlock:K<block::gen::Block>{block::gen::Block::Record bF;FullMERKLE_UPDATE<FullShardState> cn;FullBlockExtra bN;FullBlock():K("Block"),cn(FullShardState()){}N bg(A&ctx,U&cs,int o=0){(bo.unpack(cs,bF));cn.bd(ctx,bF.cn,o+1);bN.bd(ctx,bF.bN,o+1,de);}N bt(A&ctx,S&cb,int o=0){cb.bQ(bF.global_id,32).bb(bF.info).bb(bF.value_flow).bb(cn.by(ctx,o+1)).bb(bN.by(ctx,o+1));}N bh(A&ctx,U&cs,int o=0){(
cs.fetch_int_to(32,bF.global_id)&&cs.fetch_ref_to(bF.info)&&cs.fetch_ref_to(bF.value_flow));cn.bk(ctx,cs.bl(),o+1);bN.bk(ctx,cs.bl(),o+1,de);}N bu(A&ctx,S&cb,int o=0){cb.bQ(0x11ef55aa,32).bQ(bF.global_id,32).bb(bF.info).bb(bF.value_flow).bb(cn.bc(ctx,o+1)).bb(bN.bc(ctx,o+1));}};cU NullStream:public ostream{cU NullBuffer:public streambuf{public:int overflow(int c){B c;}}m_nb;public:NullStream():ostream(&m_nb){}};
#define Y cP
#define O if
#define Q for
#define F(x)for(int i=0;i<(x);++i)
using I=int;namespace LQ{typedef uint8_t U8;typedef uint16_t U16;typedef uint32_t U32;typedef uint64_t U64;N E(J bf* msg=0){throw runtime_error(msg);}I lg(G x){G r=0;O(x>=65536)r=16,x>>=16;O(x>=256)r+=8,x>>=8;O(x>=16)r+=4,x>>=4;B
"\x00\x01\x02\x02\x03\x03\x03\x03\x04\x04\x04\x04\x04\x04\x04\x04"[x]+r;}I tolower(I c){B(c>='A'&&c<='Z')?c+'a'-'A':c;}
bD cS(int64_t x,I n=1){bD r;Q(;x||n>0;x/=10,--n)r=bD(1,'0'+x%10)+r;B r;}V cY{bO I get()= 0;bO I read(bf* buf,I n){I i=0,c;ba(i<n&&(c=get())>=0)
buf[i++]=c;B i;}bO ~cY(){}};V dv{bO N put(I c)= 0;bO N bx(J bf* buf,I n){F(n)put(U8(buf[i]));}bO ~dv(){}};I toU16(J bf* p){B(p[0]&255)+256*(p[1]&255);}J I compsize[256]={0,2,3,2,3,4,6,6,3,5};cO<cU T>V cz{T *bj;bq n;I offset;N operator=(J cz&);cz(J cz&);cz(bq sz=0,I ex=0):bj(0),n(0),offset(0){bm(sz,ex);}
N bm(bq sz,I ex=0){ba(ex>0){O(sz>sz*2)E(0);sz*=2,--ex;}O(n>0){::free((bf*)bj-offset);}n=0;offset=0;O(sz==0)B;n=sz;J bq nb=128+n*sizeof(T);O(nb<=128||(nb-128)/sizeof(T)!=n)n=0,E(0);bj=(T*)::calloc(nb,1);O(!bj)n=0,E(0);offset=64-(((bf*)bj-(bf*)0)&63);bj=(T*)((bf*)bj+offset);}~cz(){bm(0);}
bq be(){B n;}
I isize(){B I(n);}
T&operator[](bq i){B bj[i];}
T&operator()(bq i){B bj[i&(n-1)];}};typedef enum{NONE,CONS,CM,ICM,MATCH,AVG,MIX2,MIX,ISSE,SSE}CompType;V Decoder;V ZP{ZP(){output=0;rcode=0;rcode_size=0;clear();outbuf.bm(1<<14);bufptr=0;}N clear(){ck=bU=bB=0;a=b=c=d=f=pc=0;D.bm(0);h.bm(0);m.bm(0);r.bm(0);}N inith(){df(D[2],D[3]);}
N initp(){df(D[4],D[5]);}
N run(U32 input);I read(cY* in2){I cv=in2->get();cv+=in2->get()*256;D.bm(cv+300);ck=bU=bB=0;D[ck++]=cv&255;D[ck++]=cv>>8;ba(ck<7)D[ck++]=in2->get();I n=D[ck-1];F(n){I bo=in2->get();D[ck++]=bo;I be=compsize[bo];Q(I j=1;j<be;++j)
D[ck++]=in2->get();}O((D[ck++]=in2->get())!=0)E(0);bU=bB=ck+128;ba(bB<cv+129){I op=in2->get();D[bB++]=op;}O((D[bB++]=in2->get())!=0)E(0);B ck+bB-bU;}cN bx(dv* out2,cN pp){O(D.be()<=6)B false;O(!pp){F(ck)out2->put(D[i]);}Y{out2->put((bB-bU)&255);out2->put((bB-bU)>>8);}Q(I i=bU;i<bB;++i)
out2->put(D[i]);B de;}I step(U32 input,I mode);dv* output;U32 H(I i){B h(i);}
N flush(){O(output)output->bx(&outbuf[0],bufptr);bufptr=0;}N outc(I ch){O(ch<0||(outbuf[bufptr]=ch,++bufptr==outbuf.isize()))flush();}cz<U8> D;I ck,bU,bB;cz<U8> m;cz<U32> h,r;cz<bf> outbuf;I bufptr;U32 a,b,c,d;I f,pc,rcode_size;U8* rcode;N df(I hbits,I mbits){h.bm(1,hbits);m.bm(1,mbits);r.bm(256);a=b=c=d=pc=f=0;}I execute(){switch(D[pc++]){u 1:++a;g;u 2:--a;g;u 3:a=~a;g;u 4:a=0;g;u 7:a=r[D[pc++]];g;u 8:swap(b);g;u 9:++b;g;u 10:--b;g;u 11:b=~b;g;u 12:b=0;g;u 15:b=r[D[pc++]];g;u 16:swap(c);g;u 17:++c;g;u 18:--c;g;u 19:c=~c;g;u 20:c=0;g;u 23:c=r[D[pc++]];g;u 24:swap(d);g;u 25:++d;g;u 26:--d;g;u 27:d=~d;g;u 28:d=0;g;u 31:d=r[D[pc++]];g;u 32:swap(m(b));g;u 33:++m(b);g;u 34:--m(b);g;u 35:m(b)= ~m(b);g;u 36:m(b)= 0;g;u 39:O(f)pc+=((D[pc]+128)&255)-127;Y ++pc;g;u 40:swap(m(c));g;u 41:++m(c);g;u 42:--m(c);g;u 43:m(c)= ~m(c);g;u 44:m(c)= 0;g;u 47:O(!f)pc+=((D[pc]+128)&255)-127;Y ++pc;g;u 48:swap(h(d));g;u 49:++h(d);g;u 50:--h(d);g;u 51:h(d)= ~h(d);g;u 52:h(d)= 0;g;u 55:r[D[pc++]]=a;g;u 56:B 0 ;u 57:outc(a&255);g;u 59:a=(a+m(b)+512)*773;g;u 60:h(d)= (h(d)+a+512)*773;g;u 63:pc+=((D[pc]+128)&255)-127;g;u 64:g;u 65:a=b;g;u 66:a=c;g;u 67:a=d;g;u 68:a=m(b);g;u 69:a=m(c);g;u 70:a=h(d);g;u 71:a=D[pc++];g;u 72:b=a;g;u 73:g;u 74:b=c;g;u 75:b=d;g;u 76:b=m(b);g;u 77:b=m(c);g;u 78:b=h(d);g;u 79:b=D[pc++];g;u 80:c=a;g;u 81:c=b;g;u 82:g;u 83:c=d;g;u 84:c=m(b);g;u 85:c=m(c);g;u 86:c=h(d);g;u 87:c=D[pc++];g;u 88:d=a;g;u 89:d=b;g;u 90:d=c;g;u 91:g;u 92:d=m(b);g;u 93:d=m(c);g;u 94:d=h(d);g;u 95:d=D[pc++];g;u 96:m(b)=a;g;u 97:m(b)=b;g;u 98:m(b)=c;g;u 99:m(b)=d;g;u 100:g;u 101:m(b)=m(c);g;u 102:m(b)=h(d);g;u 103:m(b)=D[pc++];g;u 104:m(c)=a;g;u 105:m(c)=b;g;u 106:m(c)=c;g;u 107:m(c)=d;g;u 108:m(c)=m(b);g;u 109:g;u 110:m(c)=h(d);g;u 111:m(c)=D[pc++];g;u 112:h(d)=a;g;u 113:h(d)=b;g;u 114:h(d)=c;g;u 115:h(d)=d;g;u 116:h(d)=m(b);g;u 117:h(d)=m(c);g;u 118:g;u 119:h(d)=D[pc++];g;u 128:a+=a;g;u 129:a+=b;g;u 130:a+=c;g;u 131:a+=d;g;u 132:a+=m(b);g;u 133:a+=m(c);g;u 134:a+=h(d);g;u 135:a+=D[pc++];g;u 136:a-=a;g;u 137:a-=b;g;u 138:a-=c;g;u 139:a-=d;g;u 140:a-=m(b);g;u 141:a-=m(c);g;u 142:a-=h(d);g;u 143:a-=D[pc++];g;u 144:a*=a;g;u 145:a*=b;g;u 146:a*=c;g;u 147:a*=d;g;u 148:a*=m(b);g;u 149:a*=m(c);g;u 150:a*=h(d);g;u 151:a*=D[pc++];g;u 152:div(a);g;u 153:div(b);g;u 154:div(c);g;u 155:div(d);g;u 156:div(m(b));g;u 157:div(m(c));g;u 158:div(h(d));g;u 159:div(D[pc++]);g;u 160:mod(a);g;u 161:mod(b);g;u 162:mod(c);g;u 163:mod(d);g;u 164:mod(m(b));g;u 165:mod(m(c));g;u 166:mod(h(d));g;u 167:mod(D[pc++]);g;u 168:a&=a;g;u 169:a&=b;g;u 170:a&=c;g;u 171:a&=d;g;u 172:a&=m(b);g;u 173:a&=m(c);g;u 174:a&=h(d);g;u 175:a&=D[pc++];g;u 176:a&=~a;g;u 177:a&=~b;g;u 178:a&=~c;g;u 179:a&=~d;g;u 180:a&=~m(b);g;u 181:a&=~m(c);g;u 182:a&=~h(d);g;u 183:a&=~D[pc++];g;u 184:a|=a;g;u 185:a|=b;g;u 186:a|=c;g;u 187:a|=d;g;u 188:a|=m(b);g;u 189:a|=m(c);g;u 190:a|=h(d);g;u 191:a|=D[pc++];g;u 192:a^=a;g;u 193:a^=b;g;u 194:a^=c;g;u 195:a^=d;g;u 196:a^=m(b);g;u 197:a^=m(c);g;u 198:a^=h(d);g;u 199:a^=D[pc++];g;u 200:a<<=(a&31);g;u 201:a<<=(b&31);g;u 202:a<<=(c&31);g;u 203:a<<=(d&31);g;u 204:a<<=(m(b)&31);g;u 205:a<<=(m(c)&31);g;u 206:a<<=(h(d)&31);g;u 207:a<<=(D[pc++]&31);g;u 208:a>>=(a&31);g;u 209:a>>=(b&31);g;u 210:a>>=(c&31);g;u 211:a>>=(d&31);g;u 212:a>>=(m(b)&31);g;u 213:a>>=(m(c)&31);g;u 214:a>>=(h(d)&31);g;u 215:a>>=(D[pc++]&31);g;u 216:f=1;g;u 217:f=(a==b);g;u 218:f=(a==c);g;u 219:f=(a==d);g;u 220:f=(a==U32(m(b)));g;u 221:f=(a==U32(m(c)));g;u 222:f=(a==h(d));g;u 223:f=(a==U32(D[pc++]));g;u 224:f=0;g;u 225:f=(a<b);g;u 226:f=(a<c);g;u 227:f=(a<d);g;u 228:f=(a<U32(m(b)));g;u 229:f=(a<U32(m(c)));g;u 230:f=(a<h(d));g;u 231:f=(a<U32(D[pc++]));g;u 232:f=0;g;u 233:f=(a>b);g;u 234:f=(a>c);g;u 235:f=(a>d);g;u 236:f=(a>U32(m(b)));g;u 237:f=(a>U32(m(c)));g;u 238:f=(a>h(d));g;u 239:f=(a>U32(D[pc++]));g;u 255:O((pc=bU+D[pc]+256*D[pc+1])>=bB)E(0);g;default:E(0);}B 1;}N div(U32 x){O(x)a/=x;Y a=0;}
N mod(U32 x){O(x)a%=x;Y a=0;}
N swap(U32&x){a^=x;x^=a;a^=x;}
N swap(U8&x){a^=x;x^=a;a^=x;}};V dj{bq z,cxt,a,b,c;cz<U32> cm;cz<U8> ht;cz<U16> a16;N df(){z=cxt=a=b=c=0;cm.bm(0);ht.bm(0);a16.bm(0);}dj(){df();}};J U8 sns[1024]={1,2,0,0,3,5,1,0,4,6,0,1,7,9,2,0,8,11,1,1,8,11,1,1,10,12,0,2,13,15,3,0,14,17,2,1,14,17,2,1,16,19,1,2,16,19,1,2,18,20,0,3,21,23,4,0,22,25,3,1,22,25,3,1,24,27,2,2,24,27,2,2,26,29,1,3,26,29,1,3,28,30,0,4,31,33,5,0,32,35,4,1,32,35,4,1,34,37,3,2,34,37,3,2,36,39,2,3,36,39,2,3,38,41,1,4,38,41,1,4,40,42,0,5,43,33,6,0,44,47,5,1,44,47,5,1,46,49,4,2,46,49,4,2,48,51,3,3,48,51,3,3,50,53,2,4,50,53,2,4,52,55,1,5,52,55,1,5,40,56,0,6,57,45,7,0,58,47,6,1,58,47,6,1,60,63,5,2,60,63,5,2,62,65,4,3,62,65,4,3,64,67,3,4,64,67,3,4,66,69,2,5,66,69,2,5,52,71,1,6,52,71,1,6,54,72,0,7,73,59,8,0,74,61,7,1,74,61,7,1,76,63,6,2,76,63,6,2,78,81,5,3,78,81,5,3,80,83,4,4,80,83,4,4,82,85,3,5,82,85,3,5,66,87,2,6,66,87,2,6,68,89,1,7,68,89,1,7,70,90,0,8,91,59,9,0,92,77,8,1,92,77,8,1,94,79,7,2,94,79,7,2,96,81,6,3,96,81,6,3,98,101,5,4,98,101,5,4,100,103,4,5,100,103,4,5,82,105,3,6,82,105,3,6,84,107,2,7,84,107,2,7,86,109,1,8,86,109,1,8,70,110,0,9,111,59,10,0,112,77,9,1,112,77,9,1,114,97,8,2,114,97,8,2,116,99,7,3,116,99,7,3,62,101,6,4,62,101,6,4,80,83,5,5,80,83,5,5,100,67,4,6,100,67,4,6,102,119,3,7,102,119,3,7,104,121,2,8,104,121,2,8,86,123,1,9,86,123,1,9,70,124,0,10,125,59,11,0,126,77,10,1,126,77,10,1,128,97,9,2,128,97,9,2,60,63,8,3,60,63,8,3,66,69,3,8,66,69,3,8,104,131,2,9,104,131,2,9,86,133,1,10,86,133,1,10,70,134,0,11,135,59,12,0,136,77,11,1,136,77,11,1,138,97,10,2,138,97,10,2,104,141,2,10,104,141,2,10,86,143,1,11,86,143,1,11,70,144,0,12,145,59,13,0,146,77,12,1,146,77,12,1,148,97,11,2,148,97,11,2,104,151,2,11,104,151,2,11,86,153,1,12,86,153,1,12,70,154,0,13,155,59,14,0,156,77,13,1,156,77,13,1,158,97,12,2,158,97,12,2,104,161,2,12,104,161,2,12,86,163,1,13,86,163,1,13,70,164,0,14,165,59,15,0,166,77,14,1,166,77,14,1,168,97,13,2,168,97,13,2,104,171,2,13,104,171,2,13,86,173,1,14,86,173,1,14,70,174,0,15,175,59,16,0,176,77,15,1,176,77,15,1,178,97,14,2,178,97,14,2,104,181,2,14,104,181,2,14,86,183,1,15,86,183,1,15,70,184,0,16,185,59,17,0,186,77,16,1,186,77,16,1,74,97,15,2,74,97,15,2,104,89,2,15,104,89,2,15,86,187,1,16,86,187,1,16,70,188,0,17,189,59,18,0,190,77,17,1,86,191,1,17,70,192,0,18,193,59,19,0,194,77,18,1,86,195,1,18,70,196,0,19,193,59,20,0,197,77,19,1,86,198,1,19,70,196,0,20,199,77,20,1,86,200,1,20,201,77,21,1,86,202,1,21,203,77,22,1,86,204,1,22,205,77,23,1,86,206,1,23,207,77,24,1,86,208,1,24,209,77,25,1,86,210,1,25,211,77,26,1,86,212,1,26,213,77,27,1,86,214,1,27,215,77,28,1,86,216,1,28,217,77,29,1,86,218,1,29,219,77,30,1,86,220,1,30,221,77,31,1,86,222,1,31,223,77,32,1,86,224,1,32,225,77,33,1,86,226,1,33,227,77,34,1,86,228,1,34,229,77,35,1,86,230,1,35,231,77,36,1,86,232,1,36,233,77,37,1,86,234,1,37,235,77,38,1,86,236,1,38,237,77,39,1,86,238,1,39,239,77,40,1,86,240,1,40,241,77,41,1,86,242,1,41,243,77,42,1,86,244,1,42,245,77,43,1,86,246,1,43,247,77,44,1,86,248,1,44,249,77,45,1,86,250,1,45,251,77,46,1,86,252,1,46,253,77,47,1,86,254,1,47,253,77,48,1,86,254,1,48,0,0,0,0
};V StateTable{U8 ns[1024];I bE(I s,I y){B ns[s*4+y];}
I cminit(I s){B((ns[s*4+3]*2+1)<<22)/(ns[s*4+2]+ns[s*4+3]+1);}
StateTable(){memcpy(ns,sns,sizeof(ns));}};V P{P(ZP&zr):c8(1),dk(1),z(zr){pcode=0;pcode_size=0;initTables=false;}N df();I predict();N update(I y);I stat(I);cN isModeled(){B z.D[6]!=0;}I c8,dk,p[256];U32 h[256];ZP&z;dj comp[256];cN initTables;I dt2k[256];I dt[1024];U16 squasht[4096];short stretcht[32768];StateTable st;U8* pcode;I pcode_size;N train(dj&cr,I y){U32&pn=cr.cm(cr.cxt);U32 count=pn&0x3ff;I E=y*32767-(cr.cm(cr.cxt)>>17);pn+=(E*dt[count]&-1024)+(count<cr.z);}I squash(I x){B squasht[x+2048];}
I stretch(I x){B stretcht[x];}
I clamp2k(I x){O(x<-2048)B -2048;Y O(x>2047)B 2047;Y B x;}I clamp512k(I x){O(x<-(1<<19))B -(1<<19);Y O(x>=(1<<19))B(1<<19)-1;Y B x;}bq find(cz<U8>&ht,I sizebits,U32 cxt){I chk=cxt>>sizebits&255;bq h0=(cxt*16)&(ht.be()-16);O(ht[h0]==chk)B h0;bq h1=h0^16;O(ht[h1]==chk)B h1;bq h2=h0^32;O(ht[h2]==chk)B h2;O(ht[h0+1]<=ht[h1+1]&&ht[h0+1]<=ht[h2+1])
B memset(&ht[h0],0,16),ht[h0]=chk,h0;Y O(ht[h1+1]<ht[h2+1])
B memset(&ht[h1],0,16),ht[h1]=chk,h1;Y
B memset(&ht[h2],0,16),ht[h2]=chk,h2;}};V Decoder:cY{cY* in;Decoder(ZP&z):in(0),low(1),dg(0xFFFFFFFF),cg(0),bR(0),bH(0),pr(z),buf(cI){}I decompress(){O(pr.isModeled()){O(cg==0){F(4)cg=cg<<8|get();}O(decode(0)){B -1;}Y{I c=1;ba(c<256){I p=pr.predict()*2+1;c+=c+decode(p);pr.update(c&1);}B c-256;}}Y{O(cg==0){F(4)cg=cg<<8|get();O(cg==0)B -1;}--cg;B get();}}I dz(){I c=-1;O(pr.isModeled()){ba(cg==0)
cg=get();ba(cg&&(c=get())>=0)
cg=cg<<8|c;ba((c=get())==0);B c;}Y{O(cg==0)
Q(I i=0;i<4&&(c=get())>=0;++i)cg=cg<<8|c;ba(cg>0){ba(cg>0){--cg;O(get()<0)B E("skipped to EOF"),-1;}Q(I i=0;i<4&&(c=get())>=0;++i)cg=cg<<8|c;}O(c>=0)c=get();B c;}}N df(){pr.df();O(pr.isModeled())low=1,dg=0xFFFFFFFF,cg=0;Y low=dg=cg=0;}I stat(I x){B pr.stat(x);}
I get(){O(bR==bH){bR=0;bH=in ? in->read(&buf[0],cI):0;}B bR<bH ? U8(buf[bR++]):-1;}I buffered(){B bH-bR;}
U32 low,dg;U32 cg;U32 bR,bH;P pr;enum{cI=1<<16};cz<bf> buf;I decode(I p){U32 mid=low+U32(((dg-low)*U64(U32(p)))>>16);I y;O(cg<=mid)y=1,dg=mid;Y y=0,low=mid+1;ba((dg^low)<0x1000000){dg=dg<<8|255;low=low<<8;low+=(low==0);I c=get();cg=cg<<8|c;}B y;}};V PostProcessor{I bz,cv,ph,pm;ZP z;PostProcessor(dv* out):bz(0),cv(0),ph(0),pm(0){z.output=out;}
N df(I h,I m){bz=cv=0;ph=h;pm=m;z.clear();}I bx(I c){switch (bz){u 0:bz=c+1;O(bz==1)z.clear();g;u 1:z.outc(c);g;u 2:cv=c;bz=3;g;u 3:cv+=c*256;z.D.bm(cv+300);z.ck=8;z.bU=z.bB=z.ck+128;z.D[4]=ph;z.D[5]=pm;bz=4;g;u 4:z.D[z.bB++]=c;O(z.bB-z.bU==cv){cv=z.ck-2+z.bB-z.bU;z.D[0]=cv&255;z.D[1]=cv>>8;z.initp();bz=5;}g;u 5:z.run(c);O(c<0)z.flush();g;}B bz;}I getState()J{B bz;}};V D{D(cY* in,dv* out):z(),dec(z),pp(out){dec.in=in;}N findBlock(){I c=dec.get();z.read(&dec);}N decompress(){dec.df();pp.df(z.D[4],z.D[5]);ba((pp.getState()&3)!=1)
pp.bx(dec.decompress());ba(1){I c=dec.decompress();pp.bx(c);O(c==-1){B;}}}ZP z;Decoder dec;PostProcessor pp;};N decompress(cY* in,dv* out){D d{in,out};d.findBlock();d.decompress();}V Encoder{Encoder(ZP&z,I be=0):out(0),low(1),dg(0xFFFFFFFF),pr(z){}N df(){low=1;dg=0xFFFFFFFF;pr.df();O(!pr.isModeled())low=0,buf.bm(1<<16);}N compress(I c){O(c==-1)
encode(1,0);Y{encode(0,0);Q(I i=7;i>=0;--i){I p=pr.predict()*2+1;I y=c>>i&1;encode(y,p);pr.update(y);}}}I stat(I x){B pr.stat(x);}
dv* out;U32 low,dg;P pr;cz<bf> buf;N encode(I y,I p){U32 mid=low+U32(((dg-low)*U64(U32(p)))>>16);O(y)dg=mid;Y low=mid+1;ba((dg^low)<0x1000000){out->put(dg>>24);dg=dg<<8|255;low=low<<8;low+=(low==0);}}};V Compiler{Compiler(J bf* in,I* bn,ZP&hz,ZP&pz);J bf* in;I* bn;ZP&hz,&pz;I line,bz;typedef enum{NONE,CONS,CM,ICM,MATCH,AVG,MIX2,MIX,ISSE,SSE,JT=39,JF=47,JMP=63,LJ=255,POST=256,PCOMP,END,IF,IFNOT,ELSE,ENDIF,DO,WHILE,UNTIL,QEVER,IFL,IFNOTL,ELSEL,SEMICOLON}CompType;N bE(){Q(;*in;++in){O(*in=='\n')++line;O(*in=='(')bz+=1+(bz<0);Y O(bz>0&&*in==')')--bz;Y O(bz<0&&*in<=' ')bz=0;Y O(bz==0&&*in>' '){bz=-1;g;}}}cN matchToken(J bf* word){J bf* a=in;Q(;(*a>' '&&*a!='('&&*word);++a,++word)
O(tolower(*a)!=tolower(*word))B false;B !*word&&(*a<=' '||*a=='(');}I rtoken(I low,I dg){bE();I r=0;O(in[0]=='$'&&in[1]>='1'&&in[1]<='9'){O(in[2]=='+')r=atoi(in+3);O(bn)r+=bn[in[1]-'1'];}Y O(in[0]=='-'||(in[0]>='0'&&in[0]<='9'))r=atoi(in);B r;}I rtoken(J bf* list[]){bE();Q(I i=0;list[i];++i)
O(matchToken(list[i]))
B i;E(0);B -1;}I compile_comp(ZP&z);V Stack{LQ::cz<U16> s;bq top;Stack(I n):s(n),top(0){}N push(J U16&x){O(top>=s.be())E(0);s[top++]=x;}U16 pop(){O(top<=0)E(0);B s[--top];}};Stack dl,do_stack;};V C{C(cY* i,dv* out):enc(z),in(i),bz(INIT){enc.out=out;}
N startBlock(J bf* config,I* bn){Compiler(config,bn,z,pz);enc.out->put(1+(z.D[6]==0));z.bx(enc.out,false);bz=BLOCK1;}N startSegment(){O(bz==BLOCK1)bz=SEG1;O(bz==BLOCK2)bz=SEG2;}N postProcess(J bf* pcomp=0,I len=0);cN compress(I n=-1);N endSegment(){O(bz==SEG1)
postProcess();enc.compress(-1);enc.out->put(0);enc.out->put(0);enc.out->put(0);enc.out->put(0);enc.out->put(254);bz=BLOCK2;}I stat(I x){B enc.stat(x);}
ZP z,pz;Encoder enc;cY* in;enum{INIT,BLOCK1,SEG1,BLOCK2,SEG2}bz;};V SB:cY,dv{G bf* p;bq al,bH,bR,bP,df;N reserve(bq a){O(a<=al)B;G bf* q=0;O(a>0)q=(G bf*)(p ? realloc(p,a):malloc(a));O(a>0&&!q)E(0);p=q;al=a;}N lengthen(bq n){O(bH+n<=al)B;bq a=al;ba(bH+n>=a)a=a*2+df;reserve(a);}N operator=(J SB&);SB(J SB&);G bf* bj(){B p;}
SB(bq n=0):p(0),al(0),bH(0),bR(0),bP(bq(-1)),df(n>128?n:128){}~SB(){O(p)free(p);}
bq be()J{B bH;}
N put(I c){lengthen(1);p[bH++]=c;}N bx(J bf* buf,I n){O(n<1)B;lengthen(n);O(buf)memcpy(p+bH,buf,n);bH+=n;}I get(){B bR<bH ? p[bR++]:-1;}I read(bf* buf,I n){O(bR+n>bH)n=bH-bR;O(n>0&&buf)memcpy(buf,p+bR,n);bR+=n;B n;}J bf* c_str()J{B(J bf*)p;}
N bm(bq i){bH=i;O(bR>bH)bR=bH;}N swap(SB&s){::swap(p,s.p);::swap(al,s.al);::swap(bH,s.bH);::swap(bR,s.bR);::swap(bP,s.bP);}};double pow2(I x){double r=1;Q(;x>0;x--)r+=r;B r;}U8 stdt[712]={64,128,128,128,128,128,127,128,127,128,127,127,127,127,126,126,126,126,126,125,125,124,125,124,123,123,123,123,122,122,121,121,120,120,119,119,118,118,118,116,117,115,116,114,114,113,113,112,112,111,110,110,109,108,108,107,106,106,105,104,104,102,103,101,101,100,99,98,98,97,96,96,94,94,94,92,92,91,90,89,89,88,87,86,86,84,84,84,82,82,81,80,79,79,78,77,76,76,75,74,73,73,72,71,70,70,69,68,67,67,66,65,65,64,63,62,62,61,61,59,59,59,57,58,56,56,55,54,54,53,52,52,51,51,50,49,49,48,48,47,47,45,46,44,45,43,43,43,42,41,41,40,40,40,39,38,38,37,37,36,36,36,35,34,34,34,33,32,33,32,31,31,30,31,29,30,28,29,28,28,27,27,27,26,26,25,26,24,25,24,24,23,23,23,23,22,22,21,22,21,20,21,20,19,20,19,19,19,18,18,18,18,17,17,17,17,16,16,16,16,15,15,15,15,15,14,14,14,14,13,14,13,13,13,12,13,12,12,12,11,12,11,11,11,11,11,10,11,10,10,10,10,9,10,9,9,9,9,9,8,9,8,9,8,8,8,7,8,8,7,7,8,7,7,7,6,7,7,6,6,7,6,6,6,6,6,6,5,6,5,6,5,5,5,5,5,5,5,5,5,4,5,4,5,4,4,5,4,4,4,4,4,4,3,4,4,3,4,4,3,3,4,3,3,3,4,3,3,3,3,3,3,2,3,3,3,2,3,2,3,3,2,2,3,2,2,3,2,2,2,2,3,2,2,2,2,2,2,1,2,2,2,2,1,2,2,2,1,2,1,2,2,1,2,1,2,1,1,2,1,1,2,1,1,2,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,0,1,1,1,0,1,1,0,1,1,0,1,0,1,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0,1,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0
};N P::df(){z.inith();O(!initTables&&isModeled()){initTables=de;dt2k[0]=0;Q(I i=1;i<256;++i){dt2k[i]=2048/i;}F(1024)dt[i]=(1<<17)/(i*2+3)*2;memset(squasht,0,(1376+7)*2);Q(I i=1376+7;i<1376+1344;++i){squasht[i]=(U16)(32768.0 / (1+exp((i-2048)* (-1.0 / 64))));}Q(I i=2720;i<4096;++i)squasht[i]=32767;I k=16384;F(712)
Q(I j=stdt[i];j>0;--j)
stretcht[k++]=i;F(16384)stretcht[i]=-stretcht[32767-i];}F(256)h[i]=p[i]=0;F(256)comp[i].df();I n=z.D[6];J U8* cp=&z.D[7];F(n){dj&cr=comp[i];switch(cp[0]){u CONS:p[i]=(cp[1]-128)*4;g;u CM:cr.cm.bm(1,cp[1]);cr.z=cp[2]*4;Q(bq j=0;j<cr.cm.be();++j)
cr.cm[j]=0x80000000;g;u ICM:cr.z=1023;cr.cm.bm(256);cr.ht.bm(64,cp[1]);Q(bq j=0;j<cr.cm.be();++j)
cr.cm[j]=st.cminit(j);g;u MATCH:cr.cm.bm(1,cp[1]);cr.ht.bm(1,cp[2]);cr.ht(0)=1;g;u AVG:g;u MIX2:cr.c=(bq(1)<<cp[1]);cr.a16.bm(1,cp[1]);Q(bq j=0;j<cr.a16.be();++j)
cr.a16[j]=32768;g;u MIX:{I m=cp[3];cr.c=(bq(1)<<cp[1]);cr.cm.bm(m,cp[1]);Q(bq j=0;j<cr.cm.be();++j)
cr.cm[j]=65536/m;g;}u ISSE:cr.ht.bm(64,cp[1]);cr.cm.bm(512);Q(I j=0;j<256;++j){cr.cm[j*2]=1<<15;cr.cm[j*2+1]=clamp512k(stretch(st.cminit(j)>>8)*1024);}g;u SSE:cr.cm.bm(32,cp[1]);cr.z=cp[4]*4;Q(bq j=0;j<cr.cm.be();++j)
cr.cm[j]=squash((j&31)*64-992)<<17|cp[3];g;default:E(0);}cp+=compsize[*cp];}}I P::predict(){I n=z.D[6];J U8* cp=&z.D[7];F(n){dj&cr=comp[i];switch(cp[0]){u CONS:g;u CM:cr.cxt=h[i]^dk;p[i]=stretch(cr.cm(cr.cxt)>>17);g;u ICM:O(c8==1||(c8&0xf0)==16)cr.c=find(cr.ht,cp[1]+2,h[i]+16*c8);cr.cxt=cr.ht[cr.c+(dk&15)];p[i]=stretch(cr.cm(cr.cxt)>>8);g;u MATCH:O(cr.a==0)p[i]=0;Y{cr.c=(cr.ht(cr.z-cr.b)>>(7-cr.cxt))&1;p[i]=stretch(dt2k[cr.a]*(cr.c*-2+1)&32767);}g;u AVG:p[i]=(p[cp[1]]*cp[3]+p[cp[2]]*(256-cp[3]))>>8;g;u MIX2:{cr.cxt=((h[i]+(c8&cp[5]))&(cr.c-1));I w=cr.a16[cr.cxt];p[i]=(w*p[cp[2]]+(65536-w)*p[cp[3]])>>16;}g;u MIX:{I m=cp[3];cr.cxt=h[i]+(c8&cp[5]);cr.cxt=(cr.cxt&(cr.c-1))*m;I* wt=(I*)&cr.cm[cr.cxt];p[i]=0;Q(I j=0;j<m;++j)
p[i]+=(wt[j]>>8)*p[cp[2]+j];p[i]=clamp2k(p[i]>>8);}g;u ISSE:{O(c8==1||(c8&0xf0)==16)
cr.c=find(cr.ht,cp[1]+2,h[i]+16*c8);cr.cxt=cr.ht[cr.c+(dk&15)];I*wt=(I*)&cr.cm[cr.cxt*2];p[i]=clamp2k((wt[0]*p[cp[2]]+wt[1]*64)>>16);}g;u SSE:{cr.cxt=(h[i]+c8)*32;I pq=p[cp[2]]+992;O(pq<0)pq=0;O(pq>1983)pq=1983;I wt=pq&63;pq>>=6;cr.cxt+=pq;p[i]=stretch(((cr.cm(cr.cxt)>>10)*(64-wt)+(cr.cm(cr.cxt+1)>>10)*wt)>>13);cr.cxt+=wt>>5;}g;default:E(0);}cp+=compsize[cp[0]];}B squash(p[n-1]);}N P::update(I y){J U8* cp=&z.D[7];I n=z.D[6];F(n){dj&cr=comp[i];switch(cp[0]){u CONS:g;u CM:train(cr,y);g;u ICM:{cr.ht[cr.c+(dk&15)]=st.bE(cr.ht[cr.c+(dk&15)],y);U32&pn=cr.cm(cr.cxt);pn+=I(y*32767-(pn>>8))>>2;}g;u MATCH:{O(I(cr.c)!=y)cr.a=0;cr.ht(cr.z)+=cr.ht(cr.z)+y;O(++cr.cxt==8){cr.cxt=0;++cr.z;cr.z&=(1<<cp[2])-1;O(cr.a==0){cr.b=cr.z-cr.cm(h[i]);O(cr.b&(cr.ht.be()-1))
ba(cr.a<255
&&cr.ht(cr.z-cr.a-1)==cr.ht(cr.z-cr.a-cr.b-1))
++cr.a;}Y cr.a+=cr.a<255;cr.cm(h[i])=cr.z;}}g;u AVG:g;u MIX2:{I err=(y*32767-squash(p[i]))*cp[4]>>5;I w=cr.a16[cr.cxt];w+=(err*(p[cp[2]]-p[cp[3]])+(1<<12))>>13;O(w<0)w=0;O(w>65535)w=65535;cr.a16[cr.cxt]=w;}g;u MIX:{I m=cp[3];I err=(y*32767-squash(p[i]))*cp[4]>>4;I* wt=(I*)&cr.cm[cr.cxt];Q(I j=0;j<m;++j)
wt[j]=clamp512k(wt[j]+((err*p[cp[2]+j]+(1<<12))>>13));}g;u ISSE:{I err=y*32767-squash(p[i]);I*wt=(I*)&cr.cm[cr.cxt*2];wt[0]=clamp512k(wt[0]+((err*p[cp[2]]+(1<<12))>>13));wt[1]=clamp512k(wt[1]+((err+16)>>5));cr.ht[cr.c+(dk&15)]=st.bE(cr.cxt,y);}g;u SSE:train(cr,y);g;default:assert(0);}cp+=compsize[cp[0]];}c8+=c8+y;O(c8>=256){z.run(c8-256);dk=1;c8=1;F(n)h[i]=z.H(i);}Y O(c8>=16&&c8<32)
dk=(dk&0xf)<<5|y<<4|1;Y
dk=(dk&0x1f0)|(((dk&0xf)*2+y)&0xf);}J bf*compname[256]={"","J","cm","icm","match","avg","mix2","mix","isse","sse",0};J bf*opcodelist[272]={"E","a++","a--","a!","a=0","","","a=r","b<>a","b++","b--","b!","b=0","","","b=r","c<>a","c++","c--","c!","c=0","","","c=r","d<>a","d++","d--","d!","d=0","","","d=r","*b<>a","*b++","*b--","*b!","*b=0","","","jt","*c<>a","*c++","*c--","*c!","*c=0","","","jf","*d<>a","*d++","*d--","*d!","*d=0","","","r=a","halt","out","","hash","hashd","","","jmp","a=a","a=b","a=c","a=d","a=*b","a=*c","a=*d","a=","b=a","b=b","b=c","b=d","b=*b","b=*c","b=*d","b=","c=a","c=b","c=c","c=d","c=*b","c=*c","c=*d","c=","d=a","d=b","d=c","d=d","d=*b","d=*c","d=*d","d=","*b=a","*b=b","*b=c","*b=d","*b=*b","*b=*c","*b=*d","*b=","*c=a","*c=b","*c=c","*c=d","*c=*b","*c=*c","*c=*d","*c=","*d=a","*d=b","*d=c","*d=d","*d=*b","*d=*c","*d=*d","*d=","","","","","","","","","a+=a","a+=b","a+=c","a+=d","a+=*b","a+=*c","a+=*d","a+=","a-=a","a-=b","a-=c","a-=d","a-=*b","a-=*c","a-=*d","a-=","a*=a","a*=b","a*=c","a*=d","a*=*b","a*=*c","a*=*d","a*=","a/=a","a/=b","a/=c","a/=d","a/=*b","a/=*c","a/=*d","a/=","a%=a","a%=b","a%=c","a%=d","a%=*b","a%=*c","a%=*d","a%=","a&=a","a&=b","a&=c","a&=d","a&=*b","a&=*c","a&=*d","a&=","a&~a","a&~b","a&~c","a&~d","a&~*b","a&~*c","a&~*d","a&~","a|=a","a|=b","a|=c","a|=d","a|=*b","a|=*c","a|=*d","a|=","a^=a","a^=b","a^=c","a^=d","a^=*b","a^=*c","a^=*d","a^=","a<<=a","a<<=b","a<<=c","a<<=d","a<<=*b","a<<=*c","a<<=*d","a<<=","a>>=a","a>>=b","a>>=c","a>>=d","a>>=*b","a>>=*c","a>>=*d","a>>=","a==a","a==b","a==c","a==d","a==*b","a==*c","a==*d","a==","a<a","a<b","a<c","a<d","a<*b","a<*c","a<*d","a<","a>a","a>b","a>c","a>d","a>*b","a>*c","a>*d","a>","","","","","","","","","","","","","","","","lj","post","pcomp","end","O","ifnot","Y","endif","do","ba","until","Qever","ifl","ifnotl","Yl",";",0};I Compiler::compile_comp(ZP&z){I op=0;J I comp_begin=z.bB;ba(de){op=rtoken(opcodelist);O(op==POST||op==PCOMP||op==END)g;I bT=-1;I operand2=-1;O(op==IF){op=JF;bT=0;dl.push(z.bB+1);}Y O(op==IFNOT){op=JT;bT=0;dl.push(z.bB+1);}Y O(op==IFL||op==IFNOTL){O(op==IFL)z.D[z.bB++]=(JT);O(op==IFNOTL)z.D[z.bB++]=(JF);z.D[z.bB++]=(3);op=LJ;bT=operand2=0;dl.push(z.bB+1);}Y O(op==ELSE||op==ELSEL){O(op==ELSE)op=JMP,bT=0;O(op==ELSEL)op=LJ,bT=operand2=0;I a=dl.pop();O(z.D[a-1]!=LJ){I j=z.bB-a+1+(op==LJ);z.D[a]=j;}Y{I j=z.bB-comp_begin+2+(op==LJ);z.D[a]=j&255;z.D[a+1]=(j>>8)&255;}dl.push(z.bB+1);}Y O(op==ENDIF){I a=dl.pop();I j=z.bB-a-1;O(z.D[a-1]!=LJ){z.D[a]=j;}Y{j=z.bB-comp_begin;z.D[a]=j&255;z.D[a+1]=(j>>8)&255;}}Y O(op==DO){do_stack.push(z.bB);}Y O(op==WHILE||op==UNTIL||op==QEVER){I a=do_stack.pop();I j=a-z.bB-2;O(j>=-127){O(op==WHILE)op=JT;O(op==UNTIL)op=JF;O(op==QEVER)op=JMP;bT=j&255;}Y{j=a-comp_begin;O(op==WHILE){z.D[z.bB++]=(JF);z.D[z.bB++]=(3);}O(op==UNTIL){z.D[z.bB++]=(JT);z.D[z.bB++]=(3);}op=LJ;bT=j&255;operand2=j>>8;}}Y O((op&7)==7){O(op==LJ){bT=rtoken(0,65535);operand2=bT>>8;bT&=255;}Y O(op==JT||op==JF||op==JMP){bT=rtoken(-128,127);bT&=255;}Y
bT=rtoken(0,255);}O(op>=0&&op<=255)
z.D[z.bB++]=(op);O(bT>=0)
z.D[z.bB++]=(bT);O(operand2>=0)
z.D[z.bB++]=(operand2);}z.D[z.bB++]=(0);B op;}Compiler::Compiler(J bf* in_,I* args_,ZP&hz_,ZP&pz_):in(in_),bn(args_),hz(hz_),pz(pz_),dl(1000),do_stack(1000){line=1;bz=0;hz.clear();pz.clear();hz.D.bm(68000);bE();hz.D[2]=rtoken(0,255);hz.D[3]=rtoken(0,255);hz.D[4]=rtoken(0,255);hz.D[5]=rtoken(0,255);J I n=hz.D[6]=rtoken(0,255);hz.ck=7;F(n){rtoken(i,i);CompType bo=CompType(rtoken(compname));hz.D[hz.ck++]=bo;I clen=LQ::compsize[bo&255];Q(I j=1;j<clen;++j)
hz.D[hz.ck++]=rtoken(0,255);}hz.D[hz.ck++];hz.bU=hz.bB=hz.ck+128;bE();I op=compile_comp(hz);I cv=hz.ck-2+hz.bB-hz.bU;hz.D[0]=cv&255;hz.D[1]=cv>>8;O(op==POST){rtoken(0,0);bE();}Y O(op==PCOMP){pz.D.bm(68000);pz.D[4]=hz.D[4];pz.D[5]=hz.D[5];pz.ck=8;pz.bU=pz.bB=pz.ck+128;bE();ba(*in&&*in!=';'){++in;}O(*in)++in;op=compile_comp(pz);I len=pz.ck-2+pz.bB-pz.bU;pz.D[0]=len&255;pz.D[1]=len>>8;}}V MemoryReader:cY{J bf* p;MemoryReader(J bf* p_):p(p_){}I get(){B *p++&255;}};N C::postProcess(J bf* pcomp,I len){O(bz==SEG2)B;enc.df();O(!pcomp){len=pz.bB-pz.bU;O(len>0){pcomp=(J bf*)&pz.D[pz.bU];}}Y O(len==0){len=toU16(pcomp);pcomp+=2;}O(len>0){enc.compress(1);enc.compress(len&255);enc.compress((len>>8)&255);F(len)enc.compress(pcomp[i]&255);}Y
enc.compress(0);bz=SEG2;}cN C::compress(I n){O(bz==SEG1)
postProcess();J I cI=1<<14;bf buf[cI];ba(n){I nbuf=cI;O(n>=0&&n<nbuf)nbuf=n;I nr=in->read(buf,nbuf);O(nr<=0)B false;O(n>=0)n-=nr;F(nr){I ch=U8(buf[i]);enc.compress(ch);}}B de;}N ZP::run(U32 input){pc=bU;a=input;ba(execute());}
#define AS 256
#define BS (AS*AS)
#define SSIT 8
#define SSB 1024
#define TR_STACKSIZE 64
#define bI(_a,_b)do{t=(_a);(_a)=(_b);(_b)=t;}ba(0)
#define MIN(_a,_b)(((_a)<(_b))?(_a):(_b))
#define MAX(_a,_b)(((_a)>(_b))?(_a):(_b))
#define SP(_a,_b,_c,_d)do{assert(bv<bS);bG[bv].a=(_a),bG[bv].b=(_b),bG[bv].c=(_c),bG[bv++].d=(_d);}ba(0)
#define S5(_a,_b,_c,_d,_e)do{assert(bv<bS);bG[bv].a=(_a),bG[bv].b=(_b),bG[bv].c=(_c),bG[bv].d=(_d),bG[bv++].e=(_e);}ba(0)
#define STACK_POP(_a,_b,_c,_d)do{assert(0<=bv);O(bv==0){B;}(_a)= bG[--bv].a,(_b)= bG[bv].b,(_c)= bG[bv].c,(_d)= bG[bv].d;}ba(0)
#define cj(_a,_b,_c,_d,_e)do{assert(0<=bv);O(bv==0){B;}(_a)= bG[--bv].a,(_b)= bG[bv].b,(_c)= bG[bv].c,(_d)= bG[bv].d,(_e)= bG[bv].e;}ba(0)
#define cT(_c0)cC[(_c0)]
#define cq(_c0,_c1)(ct[((_c1)<<8)|(_c0)])
#define BB(_c0,_c1)(ct[((_c0)<<8)|(_c1)])
#define R(v)v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v
J I cu[256]={-1,0,1,1,2,2,2,2,3,3,3,3,3,3,3,3,R(4),R(5),R(5),R(6),R(6),R(6),R(6),R(7),R(7),R(7),R(7),R(7),R(7),R(7),R(7),};
#undef R
I cZ(I n){B(n&0xff00)?
8+cu[(n >> 8)&0xff]:0+cu[(n >> 0)&0xff];}I dqq_table[256] ={0};I ss_isqrt(I x){I y,e;O(x >= (SSB * SSB)){B SSB;}
e=(x&0xffff0000)?
((x&0xff000000)?
24+cu[(x >> 24)&0xff]:16+cu[(x >> 16)&0xff]):((x&0x0000ff00)?
8+cu[(x >> 8)&0xff]:0+cu[(x >> 0)&0xff]);O(dqq_table[255] != 255){Q(I i=0;i<256;++i){dqq_table[i]=(I)(16 * sqrt(i));}}O(e >= 16){y=dqq_table[x >> ((e-6)- (e&1))] << ((e >> 1)- 7);O(e >= 24){y=(y+1+x / y)>> 1;}
y=(y+1+x / y)>> 1;}Y O(e >= 8){y=(dqq_table[x >> ((e-6)- (e&1))] >> (7-(e >> 1)))+ 1;}Y{B dqq_table[x] >> 4;}B(x<(y * y))? y-1:y;}I bW(J G bf*T,J I*p1,J I*p2,I W){J G bf*U1,*U2,*U1n,*U2n;Q(U1=T+W+*p1,U2=T+W+*p2,U1n=T+*(p1+1)+ 2,U2n=T+*(p2+1)+ 2;(U1<U1n)&&(U2<U2n)&&(*U1==*U2);++U1,++U2){}B U1<U1n ?
(U2<U2n ? *U1-*U2:1):(U2<U2n ? -1:0);}N ss_insertionsort(J G bf*T,J I*PA,I*F,I*L,I W){I*i,*j,t,r;Q(i=L-2;F<=i;--i){Q(t=*i,j=i+1;0<(r=bW(T,PA+t,PA+*j,W));){do{*(j-1)= *j;}ba((++j<L)&&(*j<0));O(L<=j){g;}}O(r==0){*j=~*j;}
*(j-1)= t;}}N ss_fixdown(J G bf*Td,J I*PA,I*SA,I i,I be){I j,k,v,c,d,e;Q(v=SA[i],c=Td[PA[v]];(j=2 * i+1)< be;SA[i]=SA[k],i=k){d=Td[PA[SA[k=j++]]];O(d<(e=Td[PA[SA[j]]])){k=j;d=e;}
O(d<=c){g;}}SA[i]=v;}N ss_heapsort(J G bf*Td,J I*PA,I*SA,I be){I i,m,t;m=be;O((be % 2)== 0){m--;O(Td[PA[SA[m / 2]]]<Td[PA[SA[m]]]){bI(SA[m],SA[m / 2]);}}Q(i=m / 2-1;0<=i;--i){ss_fixdown(Td,PA,SA,i,m);}
O((be % 2)== 0){bI(SA[0],SA[m]);ss_fixdown(Td,PA,SA,0,m);}
Q(i=m-1;0<i;--i){t=SA[0],SA[0]=SA[i];ss_fixdown(Td,PA,SA,0,i);SA[i]=t;}}I*dA(J G bf*Td,J I*PA,I*v1,I*v2,I*v3){I*t;O(Td[PA[*v1]]>Td[PA[*v2]]){bI(v1,v2);}
O(Td[PA[*v2]]>Td[PA[*v3]]){O(Td[PA[*v1]]>Td[PA[*v3]]){B v1;}
Y{B v3;}}B v2;}I*ss_median5(J G bf*Td,J I*PA,I*v1,I*v2,I*v3,I*v4,I*v5){I*t;O(Td[PA[*v2]]>Td[PA[*v3]]){bI(v2,v3);}
O(Td[PA[*v4]]>Td[PA[*v5]]){bI(v4,v5);}
O(Td[PA[*v2]]>Td[PA[*v4]]){bI(v2,v4);bI(v3,v5);}
O(Td[PA[*v1]]>Td[PA[*v3]]){bI(v1,v3);}
O(Td[PA[*v1]]>Td[PA[*v4]]){bI(v1,v4);bI(v3,v5);}
O(Td[PA[*v3]]>Td[PA[*v4]]){B v4;}
B v3;}I*ss_pivot(J G bf*Td,J I*PA,I*F,I*L){I*M;I t;t=L-F;M=F+t / 2;O(t<=512){O(t<=32){B dA(Td,PA,F,M,L-1);}Y{t >>= 2;B ss_median5(Td,PA,F,F+t,M,L-1-t,L-1);}}t >>= 3;F=dA(Td,PA,F,F+t,F+(t << 1));M=dA(Td,PA,M-t,M,M+t);L=dA(Td,PA,L-1-(t << 1),L-1-t,L-1);B dA(Td,PA,F,M,L);}I*ss_partition(J I*PA,I*F,I*L,I W){I*a,*b,t;Q(a=F-1,b=L;;){Q(;(++a<b)&&((PA[*a]+W)>= (PA[*a+1]+1));){*a=~*a;}
Q(;(a<--b)&&((PA[*b]+W)<(PA[*b+1]+1));){}O(b<=a){g;}
t=~*b;*b=*a;*a=t;}O(F<a){*F=~*F;}
B a;}N ss_mIrosort(J G bf*T,J I*PA,I*F,I*L,I W){
#define bS 16
V{I*a,*b,c,d;}bG[bS];J G bf*Td;I*a,*b,*c,*d,*e,*f,s,t,bv,bP,v,x=0;Q(bv=0,bP=cZ(L-F);;){O((L-F)<= SSIT){O(1<(L-F)){ss_insertionsort(T,PA,F,L,W);}
STACK_POP(F,L,W,bP);dm;}Td=T+W;O(bP--==0){ss_heapsort(Td,PA,F,L-F);}
O(bP<0){Q(a=F+1,v=Td[PA[*F]];a<L;++a){O((x=Td[PA[*a]])!= v){O(1<(a-F)){g;}
v=x;F=a;}}O(Td[PA[*F]-1]<v){F=ss_partition(PA,F,a,W);}O((a-F)<= (L-a)){O(1<(a-F)){SP(a,L,W,-1);L=a,W+=1,bP=cZ(a-F);}Y{F=a,bP=-1;}}Y{O(1<(L-a)){SP(F,a,W+1,cZ(a-F));F=a,bP=-1;}Y{L=a,W+=1,bP=cZ(a-F);}}dm;}a=ss_pivot(Td,PA,F,L);v=Td[PA[*a]];bI(*F,*a);Q(b=F;(++b<L)&&((x=Td[PA[*b]])== v);){}O(((a=b)< L)&&(x<v)){Q(;(++b<L)&&((x=Td[PA[*b]])<= v);){O(x==v){bI(*b,*a);++a;}}}Q(c=L;(b<--c)&&((x=Td[PA[*c]])== v);){}O((b<(d=c))&&(x > v)){Q(;(b<--c)&&((x=Td[PA[*c]])>= v);){O(x==v){bI(*c,*d);--d;}}}Q(;b<c;){bI(*b,*c);Q(;(++b<c)&&((x=Td[PA[*b]])<= v);){O(x==v){bI(*b,*a);++a;}}Q(;(b<--c)&&((x=Td[PA[*c]])>= v);){O(x==v){bI(*c,*d);--d;}}}O(a<=d){c=b-1;O((s=a-F)>(t=b-a)){s=t;}
Q(e=F,f=b-s;0<s;--s,++e,++f){bI(*e,*f);}
O((s=d-c)>(t=L-d-1)){s=t;}
Q(e=b,f=L-s;0<s;--s,++e,++f){bI(*e,*f);}
a=F+(b-a),c=L-(d-c);b=(v<=Td[PA[*a]-1])? a:ss_partition(PA,a,c,W);O((a-F)<= (L-c)){O((L-c)<= (c-b)){SP(b,c,W+1,cZ(c-b));SP(c,L,W,bP);L=a;}Y O((a-F)<= (c-b)){SP(c,L,W,bP);SP(b,c,W+1,cZ(c-b));L=a;}Y{SP(c,L,W,bP);SP(F,a,W,bP);F=b,L=c,W+=1,bP=cZ(c-b);}}Y{O((a-F)<= (c-b)){SP(b,c,W+1,cZ(c-b));SP(F,a,W,bP);F=c;}Y O((L-c)<= (c-b)){SP(F,a,W,bP);SP(b,c,W+1,cZ(c-b));F=c;}Y{SP(F,a,W,bP);SP(c,L,W,bP);F=b,L=c,W+=1,bP=cZ(c-b);}}}Y{bP+=1;O(Td[PA[*F]-1]<v){F=ss_partition(PA,F,L,W);bP=cZ(L-F);}W+=1;}}
#undef bS
}N
dw(I*a,I*b,I n){I t;Q(;0<n;--n,++a,++b){t=*a,*a=*b,*b=t;}}N
ss_rotate(I*F,I*M,I*L){I*a,*b,t;I l,r;l=M-F,r=L-M;Q(;(0<l)&&(0<r);){O(l==r){dw(F,M,l);g;}
O(l<r){a=L-1,b=M-1;t=*a;do{*a--=*b,*b--=*a;O(b<F){*a=t;L=a;O((r-=l+1)<= l){g;}
a-=1,b=M-1;t=*a;}}ba(1);}Y{a=F,b=M;t=*a;do{*a++=*b,*b++=*a;O(L<=b){*a=t;F=a+1;O((l-=r+1)<= r){g;}
a+=1,b=M;t=*a;}}ba(1);}}}N
ss_inplacemerge(J G bf*T,J I*PA,I*F,I*M,I*L,I W){J I*p;I*a,*b;I len,half;I q,r;I x;Q(;;){O(*(L-1)< 0){x=1;p=PA+~*(L-1);}
Y{x=0;p=PA+*(L-1);}
Q(a=F,len=M-F,half=len >> 1,r=-1;0<len;len=half,half >>= 1){b=a+half;q=bW(T,PA+((0<=*b)? *b:~*b),p,W);O(q<0){a=b+1;half-=(len&1)^ 1;}Y{r=q;}}O(a<M){O(r==0){*a=~*a;}
ss_rotate(a,M,L);L-=M-a;M=a;O(F==M){g;}}--L;O(x != 0){ba(*--L<0){}}
O(M==L){g;}}}N
ss_mergeQward(J G bf*T,J I*PA,I*F,I*M,I*L,I*buf,I W){I*a,*b,*c,*cD;I t,r;cD=buf+(M-F)- 1;dw(buf,F,M-F);Q(t=*(a=F),b=buf,c=M;;){r=bW(T,PA+*b,PA+*c,W);O(r<0){do{*a++=*b;O(cD<=b){*cD=t;B;}
*b++=*a;}ba(*b<0);}Y O(r > 0){do{*a++=*c,*c++=*a;O(L<=c){ba(b<cD){*a++=*b,*b++=*a;}
*a=*b,*b=t;B;}}ba(*c<0);}Y{*c=~*c;do{*a++=*b;O(cD<=b){*cD=t;B;}
*b++=*a;}ba(*b<0);do{*a++=*c,*c++=*a;O(L<=c){ba(b<cD){*a++=*b,*b++=*a;}
*a=*b,*b=t;B;}}ba(*c<0);}}}static
N
ss_mergebackward(J G bf*T,J I*PA,I*F,I*M,I*L,I*buf,I W){J I*p1,*p2;I*a,*b,*c,*cD;I t;I r;I x;cD=buf+(L-M)- 1;dw(buf,M,L-M);x=0;O(*cD<0){p1=PA+~*cD;x |= 1;}
Y{p1=PA+*cD;}
O(*(M-1)< 0){p2=PA+~*(M-1);x |= 2;}
Y{p2=PA+*(M-1);}
Q(t=*(a=L-1),b=cD,c=M-1;;){r=bW(T,p1,p2,W);O(0<r){O(x&1){do{*a--=*b,*b--=*a;}ba(*b<0);x^=1;}
*a--=*b;O(b<=buf){*buf=t;g;}
*b--=*a;O(*b<0){p1=PA+~*b;x |= 1;}
Y{p1=PA+*b;}}Y O(r<0){O(x&2){do{*a--=*c,*c--=*a;}ba(*c<0);x^=2;}
*a--=*c,*c--=*a;O(c<F){ba(buf<b){*a--=*b,*b--=*a;}
*a=*b,*b=t;g;}O(*c<0){p2=PA+~*c;x |= 2;}
Y{p2=PA+*c;}}Y{O(x&1){do{*a--=*b,*b--=*a;}ba(*b<0);x^=1;}
*a--=~*b;O(b<=buf){*buf=t;g;}
*b--=*a;O(x&2){do{*a--=*c,*c--=*a;}ba(*c<0);x^=2;}
*a--=*c,*c--=*a;O(c<F){ba(buf<b){*a--=*b,*b--=*a;}
*a=*b,*b=t;g;}O(*b<0){p1=PA+~*b;x |= 1;}
Y{p1=PA+*b;}
O(*c<0){p2=PA+~*c;x |= 2;}
Y{p2=PA+*c;}}}}N
ss_swapmerge(J G bf*T,J I*PA,I*F,I*M,I*L,I*buf,I ci,I W){
#define bS 32
#define GETIDX(a)((0<=(a))? (a):(~(a)))
#define MERGE_(a,b,c)\
do{\
O(((c)&1)||\
(((c)&2)&&(bW(T,PA+GETIDX(*((a)- 1)),PA+*(a),W)== 0))){\
*(a)= ~*(a);\
}\
O(((c)&4)&&((bW(T,PA+GETIDX(*((b)- 1)),PA+*(b),W)== 0))){\
*(b)= ~*(b);\
}\
}ba(0)
V{I*a,*b,*c;I d;}bG[bS];I*l,*r,*lm,*rm;I m,len,half,bv,dn,bE;Q(dn=0,bv=0;;){O((L-M)<= ci){O((F<M)&&(M<L)){ss_mergebackward(T,PA,F,M,L,buf,W);}MERGE_(F,L,dn);STACK_POP(F,M,L,dn);dm;}O((M-F)<= ci){O(F<M){ss_mergeQward(T,PA,F,M,L,buf,W);}MERGE_(F,L,dn);STACK_POP(F,M,L,dn);dm;}Q(m=0,len=MIN(M-F,L-M),half=len >> 1;0<len;len=half,half >>= 1){O(bW(T,PA+GETIDX(*(M+m+half)),PA+GETIDX(*(M-m-half-1)),W)< 0){m+=half+1;half-=(len&1)^ 1;}}O(0<m){lm=M-m,rm=M+m;dw(lm,M,m);l=r=M,bE=0;O(rm<L){O(*rm<0){*rm=~*rm;O(F<lm){Q(;*--l<0;){}bE |= 4;}
bE |= 1;}Y O(F<lm){Q(;*r<0;++r){}bE |= 2;}}O((l-F)<= (L-r)){SP(r,rm,L,(bE&3)|(dn&4));M=lm,L=l,dn=(dn&3)|(bE&4);}Y{O((bE&2)&&(r==M)){bE^=6;}
SP(F,lm,l,(dn&3)|(bE&4));F=r,M=rm,dn=(bE&3)|(dn&4);}}Y{O(bW(T,PA+GETIDX(*(M-1)),PA+*M,W)== 0){*M=~*M;}MERGE_(F,L,dn);STACK_POP(F,M,L,dn);}}
#undef bS
}N sssort(J G bf*T,J I*PA,I*F,I*L,I*buf,I ci,I W,I n,I Lsuffix){I*a;I*b,*M,*curbuf;I j,k,curbufsize,Z;I i;O(Lsuffix != 0){++F;}
O((ci<SSB)&&
(ci<(L-F))&&
(ci<(Z=ss_isqrt(L-F)))){O(SSB<Z){Z=SSB;}
buf=M=L-Z,ci=Z;}Y{M=L,Z=0;}Q(a=F,i=0;SSB<(M-a);a+=SSB,++i){ss_mIrosort(T,PA,a,a+SSB,W);curbufsize=L-(a+SSB);curbuf=a+SSB;O(curbufsize<=ci){curbufsize=ci,curbuf=buf;}
Q(b=a,k=SSB,j=i;j&1;b-=k,k <<= 1,j >>= 1){ss_swapmerge(T,PA,b-k,b,b+k,curbuf,curbufsize,W);}}ss_mIrosort(T,PA,a,M,W);Q(k=SSB;i != 0;k <<= 1,i >>= 1){O(i&1){ss_swapmerge(T,PA,a-k,a,M,buf,ci,W);a-=k;}}O(Z != 0){ss_mIrosort(T,PA,M,L,W);ss_inplacemerge(T,PA,F,M,L,W);}O(Lsuffix != 0){I PAi[2];PAi[0]=PA[*(F-1)],PAi[1]=n-2;Q(a=F,i=*(F-1);(a<L)&&((*a<0)|| (0<bW(T,&(PAi[0]),PA+*a,W)));++a){*(a-1)= *a;}*(a-1)= i;}}I da(I n){B(n&0xffff0000)?
((n&0xff000000)?
24+cu[(n >> 24)&0xff]:16+cu[(n >> 16)&0xff]):((n&0x0000ff00)?
8+cu[(n >> 8)&0xff]:0+cu[(n >> 0)&0xff]);}N tr_insertionsort(J I*X,I*F,I*L){I*a,*b;I t,r;Q(a=F+1;a<L;++a){Q(t=*a,b=a-1;0 > (r=X[t]-X[*b]);){do{*(b+1)= *b;}ba((F<=--b)&&(*b<0));O(b<F){g;}}O(r==0){*b=~*b;}
*(b+1)= t;}}N tr_fixdown(J I*X,I*SA,I i,I be){I j,k,v,c,d,e;Q(v=SA[i],c=X[v];(j=2 * i+1)< be;SA[i]=SA[k],i=k){d=X[SA[k=j++]];O(d<(e=X[SA[j]])){k=j;d=e;}
O(d<=c){g;}}SA[i]=v;}N tr_heapsort(J I*X,I*SA,I be){I i,m,t;m=be;O((be % 2)== 0){m--;O(X[SA[m / 2]]<X[SA[m]]){bI(SA[m],SA[m / 2]);}}Q(i=m / 2-1;0<=i;--i){tr_fixdown(X,SA,i,m);}
O((be % 2)== 0){bI(SA[0],SA[m]);tr_fixdown(X,SA,0,m);}
Q(i=m-1;0<i;--i){t=SA[0],SA[0]=SA[i];tr_fixdown(X,SA,0,i);SA[i]=t;}}I*dB(J I*X,I*v1,I*v2,I*v3){I*t;O(X[*v1]>X[*v2]){bI(v1,v2);}
O(X[*v2]>X[*v3]){O(X[*v1]>X[*v3]){B v1;}
Y{B v3;}}B v2;}I*tr_median5(J I*X,I*v1,I*v2,I*v3,I*v4,I*v5){I*t;O(X[*v2]>X[*v3]){bI(v2,v3);}
O(X[*v4]>X[*v5]){bI(v4,v5);}
O(X[*v2]>X[*v4]){bI(v2,v4);bI(v3,v5);}
O(X[*v1]>X[*v3]){bI(v1,v3);}
O(X[*v1]>X[*v4]){bI(v1,v4);bI(v3,v5);}
O(X[*v3]>X[*v4]){B v4;}
B v3;}I*tr_pivot(J I*X,I*F,I*L){I*M,t;t=L-F;M=F+t / 2;O(t<=512){O(t<=32){B dB(X,F,M,L-1);}Y{t >>= 2;B tr_median5(X,F,F+t,M,L-1-t,L-1);}}t >>= 3;F=dB(X,F,F+t,F+(t << 1));M=dB(X,M-t,M,M+t);L=dB(X,L-1-(t << 1),L-1-t,L-1);B dB(X,F,M,L);}V tr{I c,r,i,n;};N trbudget_init(tr *b,I c,I i){b->c=c;b->r=b->i=i;}I trbudget_check(tr *b,I be){O(be<=b->r){b->r-=be;B 1;}
O(b->c==0){b->n+=be;B 0;}
b->r+=b->i-be;b->c-=1;B 1;}N tr_partition(J I*X,I*F,I*M,I*L,I**pa,I**pb,I v){I*a,*b,*c,*d,*e,*f,t,s,x=0;Q(b=M-1;(++b<L)&&((x=X[*b])== v);){}O(((a=b)< L)&&(x<v)){Q(;(++b<L)&&((x=X[*b])<= v);){O(x==v){bI(*b,*a);++a;}}}Q(c=L;(b<--c)&&((x=X[*c])== v);){}O((b<(d=c))&&(x > v)){Q(;(b<--c)&&((x=X[*c])>= v);){O(x==v){bI(*c,*d);--d;}}}Q(;b<c;){bI(*b,*c);Q(;(++b<c)&&((x=X[*b])<= v);){O(x==v){bI(*b,*a);++a;}}Q(;(b<--c)&&((x=X[*c])>= v);){O(x==v){bI(*c,*d);--d;}}}O(a<=d){c=b-1;O((s=a-F)>(t=b-a)){s=t;}
Q(e=F,f=b-s;0<s;--s,++e,++f){bI(*e,*f);}
O((s=d-c)>(t=L-d-1)){s=t;}
Q(e=b,f=L-s;0<s;--s,++e,++f){bI(*e,*f);}
F+=(b-a),L-=(d-c);}*pa=F,*pb=L;}N tr_copy(I*ISA,J I*SA,I*F,I*a,I*b,I*L,I W){I*c,*d,*e,s,v;v=b-SA-1;Q(c=F,d=a-1;c<=d;++c){O((0<=(s=*c-W))&&(ISA[s]==v)){*++d=s;ISA[s]=d-SA;}}Q(c=L-1,e=d+1,d=b;e<d;--c){O((0<=(s=*c-W))&&(ISA[s]==v)){*--d=s;ISA[s]=d-SA;}}}N tr_partialcopy(I*ISA,J I*SA,I*F,I*a,I*b,I*L,I W){I*c,*d,*e,s,v,rank,Lrank,newrank=-1;v=b-SA-1;Lrank=-1;Q(c=F,d=a-1;c<=d;++c){O((0<=(s=*c-W))&&(ISA[s]==v)){*++d=s;rank=ISA[s+W];O(Lrank != rank){Lrank=rank;newrank=d-SA;}
ISA[s]=newrank;}}Lrank=-1;Q(e=d;F<=e;--e){rank=ISA[*e];O(Lrank != rank){Lrank=rank;newrank=e-SA;}
O(newrank != rank){ISA[*e]=newrank;}}Lrank=-1;Q(c=L-1,e=d+1,d=b;e<d;--c){O((0<=(s=*c-W))&&(ISA[s]==v)){*--d=s;rank=ISA[s+W];O(Lrank != rank){Lrank=rank;newrank=d-SA;}
ISA[s]=newrank;}}}N tr_Irosort(I*ISA,J I*X,I*SA,I*F,I*L,tr *T){
#define bS TR_STACKSIZE
V{J I*a;I*b,*c;I d,e;}bG[bS];I*a,*b,*c,t,v,x=0,dh=X-ISA,Z,bE,bv,TR=-1;Q(bv=0,Z=da(L-F);;){O(Z<0){O(Z==-1){tr_partition(X-dh,F,F,L,&a,&b,L-SA-1);O(a<L){Q(c=F,v=a-SA-1;c<a;++c){ISA[*c]=v;}}O(b<L){Q(c=a,v=b-SA-1;c<b;++c){ISA[*c]=v;}}O(1<(b-a)){S5(NULL,a,b,0,0);S5(X-dh,F,L,-2,TR);TR=bv-2;}O((a-F)<= (L-b)){O(1<(a-F)){S5(X,b,L,da(L-b),TR);L=a,Z=da(a-F);}Y O(1<(L-b)){F=b,Z=da(L-b);}Y{cj(X,F,L,Z,TR);}}Y{O(1<(L-b)){S5(X,F,a,da(a-F),TR);F=b,Z=da(L-b);}Y O(1<(a-F)){L=a,Z=da(a-F);}Y{cj(X,F,L,Z,TR);}}}Y O(Z==-2){a=bG[--bv].b,b=bG[bv].c;O(bG[bv].d==0){tr_copy(ISA,SA,F,a,b,L,X-ISA);}Y{O(0<=TR){bG[TR].d=-1;}
tr_partialcopy(ISA,SA,F,a,b,L,X-ISA);}cj(X,F,L,Z,TR);}Y{O(0<=*F){a=F;do{ISA[*a]=a-SA;}ba((++a<L)&&(0<=*a));F=a;}O(F<L){a=F;do{*a=~*a;}ba(*++a<0);bE=(ISA[*a] != X[*a])? da(a-F+1):-1;O(++a<L){Q(b=F,v=a-SA-1;b<a;++b){ISA[*b]=v;}}
O(trbudget_check(T,a-F)){O((a-F)<= (L-a)){S5(X,a,L,-3,TR);X+=dh,L=a,Z=bE;}Y{O(1<(L-a)){S5(X+dh,F,a,bE,TR);F=a,Z=-3;}Y{X+=dh,L=a,Z=bE;}}}Y{O(0<=TR){bG[TR].d=-1;}
O(1<(L-a)){F=a,Z=-3;}Y{cj(X,F,L,Z,TR);}}}Y{cj(X,F,L,Z,TR);}}dm;}O((L-F)<= 8){tr_insertionsort(X,F,L);Z=-3;dm;}O(Z--==0){tr_heapsort(X,F,L-F);Q(a=L-1;F<a;a=b){Q(x=X[*a],b=a-1;(F<=b)&&(X[*b]==x);--b){*b=~*b;}}Z=-3;dm;}a=tr_pivot(X,F,L);bI(*F,*a);v=X[*F];tr_partition(X,F,F+1,L,&a,&b,v);O((L-F)!= (b-a)){bE=(ISA[*a] != v)? da(b-a):-1;Q(c=F,v=a-SA-1;c<a;++c){ISA[*c]=v;}
O(b<L){Q(c=a,v=b-SA-1;c<b;++c){ISA[*c]=v;}}
O((1<(b-a))&&(trbudget_check(T,b-a))){O((a-F)<= (L-b)){O((L-b)<= (b-a)){O(1<(a-F)){S5(X+dh,a,b,bE,TR);S5(X,b,L,Z,TR);L=a;}Y O(1<(L-b)){S5(X+dh,a,b,bE,TR);F=b;}Y{X+=dh,F=a,L=b,Z=bE;}}Y O((a-F)<= (b-a)){O(1<(a-F)){S5(X,b,L,Z,TR);S5(X+dh,a,b,bE,TR);L=a;}Y{S5(X,b,L,Z,TR);X+=dh,F=a,L=b,Z=bE;}}Y{S5(X,b,L,Z,TR);S5(X,F,a,Z,TR);X+=dh,F=a,L=b,Z=bE;}}Y{O((a-F)<= (b-a)){O(1<(L-b)){S5(X+dh,a,b,bE,TR);S5(X,F,a,Z,TR);F=b;}Y O(1<(a-F)){S5(X+dh,a,b,bE,TR);L=a;}Y{X+=dh,F=a,L=b,Z=bE;}}Y O((L-b)<= (b-a)){O(1<(L-b)){S5(X,F,a,Z,TR);S5(X+dh,a,b,bE,TR);F=b;}Y{S5(X,F,a,Z,TR);X+=dh,F=a,L=b,Z=bE;}}Y{S5(X,F,a,Z,TR);S5(X,b,L,Z,TR);X+=dh,F=a,L=b,Z=bE;}}}Y{O((1<(b-a))&&(0<=TR)){bG[TR].d=-1;}
O((a-F)<= (L-b)){O(1<(a-F)){S5(X,b,L,Z,TR);L=a;}Y O(1<(L-b)){F=b;}Y{cj(X,F,L,Z,TR);}}Y{O(1<(L-b)){S5(X,F,a,Z,TR);F=b;}Y O(1<(a-F)){L=a;}Y{cj(X,F,L,Z,TR);}}}}Y{O(trbudget_check(T,L-F)){Z=da(L-F),X+=dh;}Y{O(0<=TR){bG[TR].d=-1;}
cj(X,F,L,Z,TR);}}}
#undef bS
}N trsort(I*ISA,I*SA,I n,I W){I*X;I*F,*L;tr b;I t,dz,unsorted;trbudget_init(&b,da(n)* 2 / 3,n);Q(X=ISA+W;-n<*SA;X+=X-ISA){F=SA;dz=0;unsorted=0;do{O((t=*F)< 0){F-=t;dz+=t;}
Y{O(dz != 0){*(F+dz)= dz;dz=0;}
L=SA+ISA[t]+1;O(1<(L-F)){b.n=0;tr_Irosort(ISA,X,SA,F,L,&b);O(b.n != 0){unsorted+=b.n;}
Y{dz=F-L;}}Y O((L-F)== 1){dz=-1;}F=L;}}ba(F<(SA+n));O(dz != 0){*(F+dz)= dz;}
O(unsorted==0){g;}}}I sort_typeBstar(J G bf*T,I*SA,I*cC,I*ct,I n){I*PAb,*ISAb,*buf,i,j,k,t,m,ci,c0,c1;Q(i=0;i<AS;++i){cC[i]=0;}
Q(i=0;i<BS;++i){ct[i]=0;}
Q(i=n-1,m=n,c0=T[n-1];0<=i;){do{++cT(c1=c0);}ba((0<=--i)&&((c0=T[i])>= c1));O(0<=i){++BB(c0,c1);SA[--m]=i;Q(--i,c1=c0;(0<=i)&&((c0=T[i])<= c1);--i,c1=c0){++cq(c0,c1);}}}m=n-m;Q(c0=0,i=0,j=0;c0<AS;++c0){t=i+cT(c0);cT(c0)= i+j;i=t+cq(c0,c0);Q(c1=c0+1;c1<AS;++c1){j+=BB(c0,c1);BB(c0,c1)= j;i+=cq(c0,c1);}}O(0<m){PAb=SA+n-m;ISAb=SA+m;Q(i=m-2;0<=i;--i){t=PAb[i],c0=T[t],c1=T[t+1];SA[--BB(c0,c1)]=i;}t=PAb[m-1],c0=T[t],c1=T[t+1];SA[--BB(c0,c1)]=m-1;buf=SA+m,ci=n-(2 * m);Q(c0=AS-2,j=m;0<j;--c0){Q(c1=AS-1;c0<c1;j=i,--c1){i=BB(c0,c1);O(1<(j-i)){sssort(T,PAb,SA+i,SA+j,buf,ci,2,n,*(SA+i)== (m-1));}}}Q(i=m-1;0<=i;--i){O(0<=SA[i]){j=i;do{ISAb[SA[i]]=i;}ba((0<=--i)&&(0<=SA[i]));SA[i+1]=i-j;O(i<=0){g;}}j=i;do{ISAb[SA[i]=~SA[i]]=j;}ba(SA[--i]<0);ISAb[SA[i]]=j;}trsort(ISAb,SA,m,1);Q(i=n-1,j=m,c0=T[n-1];0<=i;){Q(--i,c1=c0;(0<=i)&&((c0=T[i])>= c1);--i,c1=c0){}O(0<=i){t=i;Q(--i,c1=c0;(0<=i)&&((c0=T[i])<= c1);--i,c1=c0){}SA[ISAb[--j]]=((t==0)|| (1<(t-i)))? t:~t;}}cq(AS-1,AS-1)= n;Q(c0=AS-2,k=m-1;0<=c0;--c0){i=cT(c0+1)- 1;Q(c1=AS-1;c0<c1;--c1){t=i-cq(c0,c1);cq(c0,c1)= i;Q(i=t,j=BB(c0,c1);j<=k;--i,--k){SA[i]=SA[k];}}BB(c0,c0+1)= i-cq(c0,c0)+ 1;cq(c0,c0)= i;}}B m;}N construct_SA(J G bf*T,I*SA,I*cC,I*ct,I n,I m){I*i,*j,*k,s,c0,c1,c2;O(0<m){Q(c1=AS-2;0<=c1;--c1){Q(i=SA+BB(c1,c1+1),j=SA+cT(c1+1)- 1,k=NULL,c2=-1;i<=j;--j){O(0<(s=*j)){*j=~s;c0=T[--s];O((0<s)&&(T[s-1]>c0)){s=~s;}
O(c0 != c2){O(0<=c2){cq(c2,c1)= k-SA;}
k=SA+cq(c2=c0,c1);}*k--=s;}Y{*j=~s;}}}}k=SA+cT(c2=T[n-1]);*k++=(T[n-2]<c2)? ~(n-1):(n-1);Q(i=SA,j=SA+n;i<j;++i){O(0<(s=*i)){c0=T[--s];O((s==0)|| (T[s-1]<c0)){s=~s;}
O(c0 != c2){cT(c2)= k-SA;k=SA+cT(c2=c0);}*k++=s;}Y{*i=~s;}}}I divsufsort(J G bf*T,I*SA,I n){I*cC,*ct;I m;I err=0;O((T==NULL)|| (SA==NULL)|| (n<0)){B -1;}
Y O(n==0){B 0;}
Y O(n==1){SA[0]=0;B 0;}
Y O(n==2){m=(T[0]<T[1]);SA[m ^ 1]=0,SA[m]=1;B 0;}
cC=(I*)malloc(AS * sizeof(I));ct=(I*)malloc(BS * sizeof(I));O((cC != NULL)&&(ct != NULL)){m=sort_typeBstar(T,SA,cC,ct,n);construct_SA(T,SA,cC,ct,n,m);}Y{err=-2;}free(ct);free(cC);B err;}V LZBuffer:LQ::cY{LQ::cz<G> ht;J G bf* in;I checkbits,level,mBoth;G htsize,n,i,m,m2,maxMatch,maxLiteral,cM,h1,h2,bucket,shift1,shift2,rb,bits,nbits,bR,bH,idx;J G* sa;G* isa;enum{cI=1<<14};G bf buf[cI];N write_literal(G i,G&lit){O(level==1){O(lit<1)B;I ll=lg(lit);putb(0,2);--ll;ba(--ll>=0){putb(1,1);putb((lit>>ll)&1,1);}putb(0,1);ba(lit)putb(in[i-lit--],8);}Y{ba(lit>0){G lit1=lit;O(lit1>64)lit1=64;put(lit1-1);Q(G j=i-lit;j<i-lit+lit1;++j)put(in[j]);lit-=lit1;}}}N write_match(G len,G off);N fill();N putb(G x,I k){x&=(1<<k)-1;bits|=x<<nbits;nbits+=k;ba(nbits>7){buf[bH++]=bits,bits>>=8,nbits-=8;}}N flush(){O(nbits>0)buf[bH++]=bits;bits=nbits=0;}N put(I c){buf[bH++]=c;}LZBuffer(SB&inbuf,I bn[],J G* sap=0):ht((bn[1]&3)==3 ? (inbuf.be()+1)*!sap
:bn[5]-bn[0]<21 ? 1u<<bn[5]
:(inbuf.be()*!sap)+(1u<<17<<bn[0])),in(inbuf.bj()),checkbits(bn[5]-bn[0]<21 ? 12-bn[0]:17+bn[0]),level(bn[1]&3),htsize(ht.be()),n(inbuf.be()),i(0),m(bn[2]),m2(bn[3]),maxMatch(cI*3),maxLiteral(cI/4),cM(bn[6]),h1(0),h2(0),bucket((1<<bn[4])-1),shift1(m>0 ? (bn[5]-1)/m+1:1),shift2(m2>0 ? (bn[5]-1)/m2+1:0),mBoth(MAX(m,m2+cM)+4),rb(bn[0]>4 ? bn[0]-4:0),bits(0),nbits(0),bR(0),bH(0),idx(0),sa(0),isa(0){O(bn[5]-bn[0]>=21||level==3){O(sap)
sa=sap;Y{sa=&ht[0];O(n>0)divsufsort((J G bf*)in,(I*)sa,n);}O(level<3){isa=&ht[n*(sap==0)];}}}I get(){I c=-1;O(bR==bH)fill();O(bR<bH)c=buf[bR++];O(bR==bH)bR=bH=0;B c;}I read(bf* p,I n){O(bR==bH)fill();I nr=n;O(nr>I(bH-bR))nr=bH-bR;O(nr)memcpy(p,buf+bR,nr);bR+=nr;O(bR==bH)bR=bH=0;B nr;}};I nbits(G x){I r;Q(r=0;x;x>>=1)r+=x&1;B r;}N LZBuffer::fill(){G lit=0;J G mask=(1<<checkbits)-1;ba(i<n&&bH*2<cI){G db=m-1;G bp=0;G blit=0;I bscore=0;O(isa){O(sa[isa[i&mask]]!=i)
Q(G j=0;j<n;++j)
O((sa[j]&~mask)==(i&~mask))
isa[sa[j]&mask]=j;Q(G h=0;h<=cM;++h){G q=isa[(h+i)&mask];O(sa[q]!=h+i)dm;Q(I j=-1;j<=1;j+=2){Q(G k=1;k<=bucket;++k){G p;O(q+j*k<n&&(p=sa[q+j*k]-h)<i){G l,l1;Q(l=h;i+l<n&&l<maxMatch&&in[p+l]==in[i+l];++l);Q(l1=h;l1>0&&in[p+l1-1]==in[i+l1-1];--l1);I score=I(l-l1)*8-lg(i-p)-4*(lit==0&&l1>0)-11;Q(G a=0;a<h;++a)score=score*5/8;O(score>bscore)db=l,bp=p,blit=l1,bscore=score;O(l<db||l<m||l>255)g;}}}O(bscore<=0||db<m)g;}}Y O(level==1||m<=64){O(m2>0){Q(G k=0;k<=bucket;++k){G p=ht[h2^k];O(p&&(p&mask)==(in[i+3]&mask)){p>>=checkbits;O(p<i&&i+db<=n&&in[p+db-1]==in[i+db-1]){G l;Q(l=cM;i+l<n&&l<maxMatch&&in[p+l]==in[i+l];++l);O(l>=m2+cM){I l1;Q(l1=cM;l1>0&&in[p+l1-1]==in[i+l1-1];--l1);I score=I(l-l1)*8-lg(i-p)-8*(lit==0&&l1>0)-11;O(score>bscore)db=l,bp=p,blit=l1,bscore=score;}}}O(db>=128)g;}}O(!m2||db<m2){Q(G k=0;k<=bucket;++k){G p=ht[h1^k];O(p&&i+3<n&&(p&mask)==(in[i+3]&mask)){p>>=checkbits;O(p<i&&i+db<=n&&in[p+db-1]==in[i+db-1]){G l;Q(l=0;i+l<n&&l<maxMatch&&in[p+l]==in[i+l];++l);I score=l*8-lg(i-p)-2*(lit>0)-11;O(score>bscore)db=l,bp=p,blit=0,bscore=score;}}O(db>=128)g;}}}J G off=i-bp;O(off>0&&bscore>0
&&db-blit>=m+(level==2)*((off>=(1<<16))+(off>=(1<<24)))){lit+=blit;write_literal(i+blit,lit);write_match(db-blit,off);}Y{db=1;++lit;}O(isa)
i+=db;Y{ba(db--){O(i+mBoth<n){G ih=((i*1234547)>>19)&bucket;J G p=(i<<checkbits)|(in[i+3]&mask);O(m2){ht[h2^ih]=p;h2=(((h2*9)<<shift2)
+(in[i+m2+cM]+1)*23456789u)&(htsize-1);}ht[h1^ih]=p;h1=(((h1*5)<<shift1)+(in[i+m]+1)*123456791u)&(htsize-1);}++i;}}O(lit>=maxLiteral)
write_literal(i,lit);}O(i==n){write_literal(n,lit);flush();}}N LZBuffer::write_match(G len,G off){O(level==1){I ll=lg(len)-1;off+=(1<<rb)-1;I lo=lg(off)-1-rb;putb((lo+8)>>3,2);putb(lo&7,3);ba(--ll>=2){putb(1,1);putb((len>>ll)&1,1);}putb(0,1);putb(len&3,2);putb(off,rb);putb(off>>rb,lo);}Y{--off;ba(len>0){J G len1=len>m*2+63 ? m+63:len>m+63 ? len-m:len;O(off<(1<<16)){put(64+len1-m);put(off>>8);put(off);}Y O(off<(1<<24)){put(128+len1-m);put(off>>16);put(off>>8);put(off);}Y{put(192+len1-m);put(off>>24);put(off>>16);put(off>>8);put(off);}len-=len1;}}}bD makeConfig(J bf* ME,I bn[]){J bf bo=ME[0];bn[0]=0;bn[1]=0;bn[2]=0;bn[3]=0;bn[4]=0;bn[5]=0;bn[6]=0;bn[7]=0;bn[8]=0;O(isdigit(*++ME))bn[0]=0;Q(I i=0;i<9&&(isdigit(*ME)|| *ME==','||*ME=='.');){O(isdigit(*ME))
bn[i]=bn[i]*10+*ME-'0';Y O(++i<9)
bn[i]=0;++ME;}bD hdr,pcomp;J I level=bn[1]&3;J cN doe8=bn[1]>=4&&bn[1]<=7;hdr="comp 9 16 0 $1+20 ";pcomp="pcomp lzpre c ;\n a> 255 O\nb=0 c=0 d=0 a=0 r=a 1 r=a 2 halt endif c=a a=d a== 0 O a=c a>>= 6 a++ d=a a== 1 O a+=c r=a 1 a=0 r=a 2 Y d++ a=c a&= 63 a+= $3 r=a 1 a=0 r=a 2 endif Y a== 1 O a=c *b=a b++\n out a=r 1 a-- a== 0 O d=0 endif r=a 1 Y a> 2 O a=r 2 a<<= 8 a|=c r=a 2 d-- Y a=r 2 a<<= 8 a|=c c=a a=b a-=c a-- c=a d=r 1 do a=*c *b=a c++ b++ out d-- a=d a> 0 ba endif endif endif halt end ";I ncomp=0;J I membits=bn[0]+20;I sb=5;bD comp;bD cH="cH\nc-- *c=a a+= 255 d=a *d=c\na=r 1 a== 0 O\na= 111\nY a== 1 O\na=*c r=a 2\na> 63 O a>>= 6 a++ a++\nY a++ a++ endif\nY\na--\nendif endif\nr=a 1\n";ba(*ME&&ncomp<254){vector<I> v;v.dp(*ME++);O(isdigit(*ME)){v.dp(*ME++-'0');ba(isdigit(*ME)|| *ME==','||*ME=='.'){O(isdigit(*ME))
v.back()=v.back()*10+*ME++-'0';Y{v.dp(0);++ME;}}}O(v[0]=='c'){ba(v.be()<3)v.dp(0);comp+=cS(ncomp)+" ";sb=11;O(v[2]<256)sb+=lg(v[2]);Y sb+=6;Q(G i=3;i<v.be();++i)
O(v[i]<512)sb+=nbits(v[i])*3/4;O(sb>membits)sb=membits;O(v[1]%1000==0)comp+="icm "+cS(sb-6-v[1]/1000)+"\n";Y comp+="cm "+cS(sb-2-v[1]/1000)+" "+cS(v[1]%1000-1)+"\n";cH+="d= "+cS(ncomp)+" *d=0\n";O(v[2]>1&&v[2]<=255){O(lg(v[2])!=lg(v[2]-1))
cH+="a=c a&= "+cS(v[2]-1)+" hashd\n";Y
cH+="a=c a%= "+cS(v[2])+" hashd\n";}Y O(v[2]>=1000&&v[2]<=1255)
cH+="a= 255 a+= "+cS(v[2]-1000)+
" d=a a=*d a-=c a> 255 O a= 255 endif d= "+
cS(ncomp)+" hashd\n";Q(G i=3;i<v.be();++i){O(i==3)cH+="b=c ";O(v[i]>=256&&v[i]<512){cH+="a=r 1 a> 1 O\na=r 2 a< 64 O\na=*b ";O(v[i]<511)cH+="a&= "+cS(v[i]-256);cH+=" hashd\nY\na>>= 6 hashd a=r 1 hashd\nendif\nY\na= 255 hashd a=r 2 hashd\nendif\n";}}++ncomp;}O(v[0]=='i'&&ncomp>0){cH+="d= "+cS(ncomp-1)+" b=c a=*d d++\n";Q(G i=1;i<v.be()&&ncomp<254;++i){Q(I j=0;j<v[i]%10;++j){cH+="hash ";O(i<v.be()-1||j<v[i]%10-1)cH+="b++ ";sb+=6;}cH+="*d=a";O(i<v.be()-1)cH+=" d++";cH+="\n";O(sb>membits)sb=membits;comp+=cS(ncomp)+" isse "+cS(sb-6-v[i]/10)+" "+cS(ncomp-1)+"\n";++ncomp;}}}B hdr+cS(ncomp)+"\n"+comp+cH+"halt\n"+pcomp;}N compressBlock(SB* in,dv* out){bD ME="3";J G n=in->be();J I arg0=MAX(lg(n+4095)-20,0);G bo=0;I commas=0,arg[4]={0};Q(I i=1;i<I(ME.be())&&commas<4;++i){O(ME[i]==','||ME[i]=='.')++commas;Y O(isdigit(ME[i]))arg[commas]=arg[commas]*10+ME[i]-'0';}O(commas==0)bo=512;Y bo=arg[1]*4+arg[2];J I level=3;J I doe8=(bo&2)*2;ME="x"+cS(arg0);bD htsz=","+cS(19+arg0+(arg0<=6));bD sasz=","+cS(21+arg0);ME+=","+cS(2+doe8)+",12,0,7"+sasz+",1c0,0,511i2";bD config;I bn[9]={0};config=makeConfig(ME.c_str(),bn);LZBuffer lz(*in,bn);LQ::C co{&lz,out};co.startBlock(config.c_str(),bn);bD cs=cS(n);co.startSegment();co.compress();co.endSegment();}}namespace zpaq{td::bK compress(td::Slice bj){I be=td::narrow_cast<int>(bj.be());LQ::SB in,out;in.bx(bj.bj(),be);LQ::compressBlock(&in,&out);B td::bK(out.c_str(),out.be());}td::bK decompress(td::Slice bj){LQ::SB in,out;in.bx(bj.bj(),bj.be());LQ::decompress(&in,&out);B td::bK(out.c_str(),out.be());}}
#undef Y
#undef O
#undef Q
#undef F
td::bK serialize_boc_opt(ostream&out,Ref<Cell> cell){(!cell.is_null());BagOfCells boc;boc.add_root(cell);(boc.import_cells().is_ok());bi be=boc.estimate_serialized_size(0);td::bK bs{be};bi buffer=(G bf*)bs.bj();boc_writers::BufferWriter cE{buffer,buffer+be};vector<int> backrefs(boc.cell_list_.be(),0);for(int i=0;i<boc.cell_count;++i){J bi&cell=boc.cell_list_[i];for(int j=0;j<cell.ref_num;++j){backrefs[cell.dd[j]]+=1;}}bi bX=cE.dq;bi dx=[&](bD label){if(bX<cE.dq){out << label << ":" << td::ConstBitPtr{bX}.to_hex((cE.dq-bX)* 8)<< endl;bX=cE.dq;}};bi store_byte=[&](G long long cc){cE.store_uint(cc,1);};bi bb=[&](G long long cc){cE.store_uint(cc,boc.info.ref_byte_size);};bi overwrite_ref=[&](int position,G long long cc){bi ptr=cE.dq;cE.dq=cE.store_start+position;bb(cc);cE.dq=ptr;};store_byte(boc.info.ref_byte_size);dx("ref-be");bb(0);dx("cell-num");vector<int> idx_to_ref(boc.cell_list_.be(),-1);vector<pair<int,bq>> refs_to_set;function<N(int,J vm::BagOfCells::CellInfo&)> store_cell;store_cell=[&](int idx,J vm::BagOfCells::CellInfo&dc_info){G bf buf[256] ={};J Ref<DataCell>&dc=dc_info.dc_ref;int mask=0;for(G j=0;j<dc_info.ref_num;++j){int dd=dc_info.dd[j];int br=backrefs.at(dd);if(br==1){mask |= (1 << j);}}int s=dc->serialize(buf,256,false);buf[0]=(buf[0]&15)+ mask * 16;cE.store_bytes(buf,s);dx("bj");for(G j=0;j<dc_info.ref_num;++j){int dd=dc_info.dd[j];int br=backrefs.at(dd);(br > 0);if(br==1){store_cell(dd,boc.cell_list_[dd]);}cP{refs_to_set.emplace_back(dd,cE.position());bb(0);dx("ref");}}};int cells_cnt=0;for(int i=0;i<boc.cell_count;++i){int k=boc.cell_count-1-i;J bi&dc_info=boc.cell_list_[k];int br=backrefs.at(k);if(br != 1){store_cell(k,dc_info);idx_to_ref[k]=cells_cnt++;}}overwrite_ref(1,cells_cnt);for(J bi&p:refs_to_set){overwrite_ref(p.second,idx_to_ref[p.first]);}bs.truncate(cE.position());B bs;}V DeserializedCell{cN special;int bits;bD bj;vector<pair<int,int>> refs{};};Ref<Cell> deserialize_boc_opt(ostream&out,td::Slice bj){(!bj.empty());int start=0;bi bX=0;bi dy=[&](bD label){if(bX<start){out << label << ":" << td::ConstBitPtr{(J G bf*)bj.bj()+ bX}.to_hex((start-bX)* 8)<< endl;bX=start;}};bi read_byte=[&](){(bj.be()> start);B(G bf)bj[start++];};bi read_int=[&](int bytes){G long long res=0;ba(bytes > 0){res=(res << 8)+ read_byte();--bytes;}B res;};bi read_bytes=[&](int bytes){bD bs(bytes,0);for(int i=0;i<bytes;++i){bs.at(i)= read_byte();}B bs;};bi ref_byte_size=(int)read_byte();dy("ref-be");bi read_ref=[&](){B read_int(ref_byte_size);};bi cell_num=read_ref();dy("cell-num");vector<DeserializedCell> bY;vector<array<pair<int,int>,4>> cells_refs;vector<int> ref_to_cd_idx(cell_num);function<N(int)> read_cell;read_cell=[&](int idx){bi d1=read_byte();bi d2=read_byte();bi ref_num=d1&7;bi special=(d1&8)> 0;bi mask=(d1 >> 4)&15;bi bytes=(d2+1)>> 1;bi bj=read_bytes(bytes);dy("bj");bi bits=bytes * 8;if(bj.be()> 0&&(d2&1)){G bf last_byte=bj[bj.be()- 1];int cF=8;ba(cF&&(last_byte&1)== 0){cF--;last_byte >>= 1;}if(cF){last_byte=(last_byte&254)<< (8-cF);cF--;}bj[bj.be()- 1]=last_byte;bits-=(8-cF);}if(idx != -1){ref_to_cd_idx.at(idx)= bY.be();}bY.dp(DeserializedCell{special,bits,bj,});int dc_idx=bY.be()- 1;for(int i=0;i<ref_num;++i){cN is_embedded=(mask >> i)&1;if(is_embedded){bY.at(dc_idx).refs.dp({bY.be(),-1});read_cell(-1);}cP{bY.at(dc_idx).refs.dp({-1,read_ref()});dy("ref");}}};for(int i=0;i<cell_num;++i){read_cell(i);}vector<Ref<Cell>> cells(bY.be());for(int i=bY.be()- 1;i >= 0;--i){bi&cd=bY[i];S cb;cb.store_bits(cd.bj.bj(),cd.bits);for(J bi&ref:cd.refs){int idx=ref.first;if(idx==-1){(ref.second != -1);idx=ref_to_cd_idx.at(ref.second);}bi&cell=cells.at(idx);(!cell.is_null());cb.bb(cell);}cells[i]=cb.finalize(cd.special);}B std::move(cells[0]);}td::bK do_compress(td::Slice bj){B zpaq::compress(bj);}td::bK do_decompress(td::Slice bj){B zpaq::decompress(bj);}td::bK compress(td::Slice bj){NullStream ofs;Ref<Cell> block_root=std_boc_deserialize(bj).move_as_ok();FullBlock block;A load_std_ctx{ofs};block.bd(load_std_ctx,block_root,0,de);A pack_opt_ctx{ofs};bi opt_block_cell=block.by(pack_opt_ctx);bi opt_ser=serialize_boc_opt(ofs,opt_block_cell);bi compressed=do_compress(opt_ser);B compressed;}td::bK decompress(td::Slice bj){NullStream ofs;bi decompressed=do_decompress(bj);bi opt_deser=deserialize_boc_opt(ofs,decompressed);FullBlock opt_block;A parse_opt_ctx{ofs};opt_block.bk(parse_opt_ctx,opt_deser,0,de);A pack_std_ctx{ofs};bi un_opt_block_cell=opt_block.bc(pack_std_ctx);bi boc=std_boc_serialize(un_opt_block_cell,31).move_as_ok();B boc;}int main(
){bD mode;cin >> mode;bD base64_data;cin >> base64_data;td::bK bj(td::base64_decode(base64_data));bj=(mode=="compress")? compress(bj):decompress(bj);cout << td::str_base64_encode(bj)<< endl;}